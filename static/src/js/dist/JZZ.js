/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ "./src/js/JZZ.js":
/*!***********************!*\
  !*** ./src/js/JZZ.js ***!
  \***********************/
/***/ (function(module, __unused_webpack_exports, __webpack_require__) {

eval("(function(global, factory) {\n  /* istanbul ignore next */\n  if (true) {\n    module.exports = factory();\n  }\n  else {}\n})(this, function() {\n\n  var _scope = typeof window === 'undefined' ? __webpack_require__.g : window;\n  var _version = '1.5.9';\n  var i, j, k, m, n;\n\n  /* istanbul ignore next */\n  var _time = Date.now || function () { return new Date().getTime(); };\n  var _startTime = _time();\n  /* istanbul ignore next */\n  var _now = typeof performance != 'undefined' && performance.now ?\n    function() { return performance.now(); } : function() { return _time() - _startTime; };\n  var _schedule = function(f) {\n    setTimeout(f, 0);\n  };\n  function _nop() {}\n  function _func(f) { return typeof f == 'function'; }\n\n  // _R: common root for all async objects\n  function _R() {\n    this._orig = this;\n    this._ready = false;\n    this._queue = [];\n    this._log = [];\n  }\n  _R.prototype._exec = function() {\n    while (this._ready && this._queue.length) {\n      var x = this._queue.shift();\n      x[0].apply(this, x[1]);\n    }\n  };\n  _R.prototype._push = function(func, arg) { this._queue.push([func, arg]); _R.prototype._exec.apply(this); };\n  _R.prototype._slip = function(func, arg) { this._queue.unshift([func, arg]); };\n  _R.prototype._pause = function() { this._ready = false; };\n  _R.prototype._resume = function() { this._ready = true; _R.prototype._exec.apply(this); };\n  _R.prototype._break = function(err) { this._orig._bad = true; this._orig._log.push(err || 'Unknown JZZ error'); };\n  _R.prototype._repair = function() { this._orig._bad = false; };\n  _R.prototype._crash = function(err) { this._break(err); this._resume(); };\n  _R.prototype._err = function() { return this._log[this._log.length - 1]; };\n  _R.prototype.log = function() { return _clone(this._log); };\n  _R.prototype._dup = function() {\n    var F = function() {};\n    F.prototype = this._orig;\n    var ret = new F();\n    ret._ready = false;\n    ret._queue = [];\n    return ret;\n  };\n  _R.prototype._image = function() { return this._dup(); };\n  _R.prototype._thenable = function() {\n    if (this.then) return this;\n    var self = this;\n    var F = function() {}; F.prototype = self;\n    var ret = new F();\n    ret.then = function(good, bad) { self._push(_then, [good, bad]); return this; };      \n    return ret;\n  };\n  function _then(good, bad) {\n    if (this._bad) {\n      if (_func(bad)) bad.apply(this, [new Error(this._err())]);\n    }\n    else {\n      if (_func(good)) good.apply(this, [this]);\n    }\n  }\n  function _wait(obj, delay) {\n    if (this._bad) obj._crash(this._err());\n    else setTimeout(function() { obj._resume(); }, delay);\n  }\n  _R.prototype.wait = function(delay) {\n    if (!delay) return this;\n    var ret = this._image();\n    this._push(_wait, [ret, delay]);\n    return ret._thenable();\n  };\n  function _kick(obj) { if (this._bad) obj._break(this._err()); obj._resume(); }\n  function _rechain(self, obj, name) {\n    self[name] = function() {\n      var arg = arguments;\n      var ret = obj._image();\n      this._push(_kick, [ret]);\n      return ret[name].apply(ret, arg);\n    };\n  }\n  function _and(q) {\n    if (!this._bad) {\n      if (_func(q)) q.apply(this); else console.log(q);\n    }\n  }\n  _R.prototype.and = function(func) { this._push(_and, [func]); return this._thenable(); };\n  function _or(q) {\n    if (this._bad) {\n      if (_func(q)) q.apply(this); else console.log(q);\n    }\n  }\n  _R.prototype.or = function(func) { this._push(_or, [func]); return this._thenable(); };\n\n  _R.prototype._info = {};\n  _R.prototype.info = function() {\n    var info = _clone(this._orig._info);\n    if (typeof info.engine == 'undefined') info.engine = 'none';\n    if (typeof info.sysex == 'undefined') info.sysex = true;\n    return info;\n  };\n  _R.prototype.name = function() { return this.info().name; };\n\n  function _close(obj) {\n    if (this._bad) obj._crash(this._err());\n    else {\n      this._break('Closed');\n      obj._resume();\n    }\n  }\n  _R.prototype.close = function() {\n    var ret = new _R();\n    if (this._close) this._push(this._close, []);\n    this._push(_close, [ret]);\n    return ret._thenable();\n  };\n\n  function _tryAny(arr) {\n    if (!arr.length) {\n      this._break();\n      return;\n    }\n    var func = arr.shift();\n    if (arr.length) {\n      var self = this;\n      this._slip(_or, [ function() { _tryAny.apply(self, [arr]); } ]);\n    }\n    try {\n      this._repair();\n      func.apply(this);\n    }\n    catch (err) {\n      this._break(err.toString());\n    }\n  }\n\n  function _push(arr, obj) {\n    for (var i = 0; i < arr.length; i++) if (arr[i] === obj) return;\n    arr.push(obj);\n  }\n  function _pop(arr, obj) {\n    for (var i = 0; i < arr.length; i++) if (arr[i] === obj) {\n      arr.splice(i, 1);\n      return;\n    }\n  }\n\n  // _J: JZZ object\n  function _J() {\n    _R.apply(this);\n  }\n  _J.prototype = new _R();\n\n  function _for(x, f) {\n    for(var k in x) if (x.hasOwnProperty(k)) f.call(this, k);\n  }\n  function _clone(obj, key, val) {\n    if (typeof key == 'undefined') return _clone(obj, [], []);\n    if (obj instanceof Object) {\n      for (var i = 0; i < key.length; i++) if (key[i] === obj) return val[i];\n      var ret;\n      if (obj instanceof Array) ret = []; else ret = {};\n      key.push(obj); val.push(ret);\n      _for(obj, function(k) { ret[k] = _clone(obj[k], key, val); });\n      return ret;\n    }\n    return obj;\n  }\n  _J.prototype._info = { name: 'JZZ.js', ver: _version, version: _version, inputs: [], outputs: [] };\n\n  var _outs = [];\n  var _ins = [];\n  var _outsW = [];\n  var _insW = [];\n\n  function _postRefresh() {\n    _jzz._info.engine = _engine._type;\n    _jzz._info.version = _engine._version;\n    _jzz._info.sysex = _engine._sysex;\n    _jzz._info.inputs = [];\n    _jzz._info.outputs = [];\n    _outs = [];\n    _ins = [];\n    _engine._allOuts = {};\n    _engine._allIns = {};\n    var i, x;\n    for (i = 0; i < _engine._outs.length; i++) {\n      x = _engine._outs[i];\n      x.engine = _engine;\n      _engine._allOuts[x.name] = x;\n      _jzz._info.outputs.push({\n        id: x.name,\n        name: x.name,\n        manufacturer: x.manufacturer,\n        version: x.version,\n        engine: _engine._type\n      });\n      _outs.push(x);\n    }\n    for (i = 0; i < _virtual._outs.length; i++) {\n      x = _virtual._outs[i];\n      _jzz._info.outputs.push({\n        id: x.name,\n        name: x.name,\n        manufacturer: x.manufacturer,\n        version: x.version,\n        engine: x.type\n      });\n      _outs.push(x);\n    }\n    for (i = 0; i < _engine._ins.length; i++) {\n      x = _engine._ins[i];\n      x.engine = _engine;\n      _engine._allIns[x.name] = x;\n      _jzz._info.inputs.push({\n        id: x.name,\n        name: x.name,\n        manufacturer: x.manufacturer,\n        version: x.version,\n        engine: _engine._type\n      });\n      _ins.push(x);\n    }\n    for (i = 0; i < _virtual._ins.length; i++) {\n      x = _virtual._ins[i];\n      _jzz._info.inputs.push({\n        id: x.name,\n        name: x.name,\n        manufacturer: x.manufacturer,\n        version: x.version,\n        engine: x.type\n      });\n      _ins.push(x);\n    }\n    if (_jzz._watcher && _jzz._watcher._handles.length) {\n      var diff = _diff(_insW, _outsW, _jzz._info.inputs, _jzz._info.outputs);\n       if (diff) {\n        for (j = 0; j < diff.inputs.removed.length; j++) {\n          x = _engine._inMap[diff.inputs.removed[j].name];\n          if (x) x._closeAll();\n        }\n        for (j = 0; j < diff.outputs.removed.length; j++) {\n          x = _engine._outMap[diff.outputs.removed[j].name];\n          if (x) x._closeAll();\n        }\n        _fireW(diff);\n      }\n    }\n    _insW = _jzz._info.inputs;\n    _outsW = _jzz._info.outputs;\n  }\n  function _refresh() {\n    if (!this._bad) _engine._refresh(this);\n  }\n  _J.prototype.refresh = function() {\n    this._push(_refresh, []);\n    return this._thenable();\n  };\n\n  function _filterList(q, arr) {\n    var i, n;\n    if (_func(q)) q = q(arr);\n    if (!(q instanceof Array)) q = [q];\n    var before = [];\n    var after = [];\n    var etc = arr.slice();\n    var a = before;\n    for (i = 0; i < q.length; i++) {\n      if (typeof q[i] == 'undefined') a = after;\n      else if (q[i] instanceof RegExp) for (n = 0; n < etc.length; n++) {\n        if (q[i].test(etc[n].name)) {\n          a.push(etc[n]);\n          etc.splice(n, 1);\n          n--;\n        }\n      }\n      else {\n        for (n = 0; n < etc.length; n++) if (q[i] + '' === n + '' || q[i] === etc[n].name || (q[i] instanceof Object && q[i].name === etc[n].name)) {\n          a.push(etc[n]);\n          etc.splice(n, 1);\n          n--;\n        }\n      }\n    }\n    return a == before ? before : before.concat(etc).concat(after);\n  }\n\n  function _notFound(port, q) {\n    var msg;\n    if (q instanceof RegExp) msg = 'Port matching ' + q + ' not found';\n    else if (q instanceof Object || typeof q == 'undefined') msg = 'Port not found';\n    else msg = 'Port \"' + q + '\" not found';\n    port._crash(msg);\n  }\n  function _openMidiOut(port, arg) {\n    if (this._bad) port._crash(this._err());\n    else {\n      var arr = _filterList(arg, _outs);\n      if (!arr.length) { _notFound(port, arg); return; }\n      var pack = function(x) { return function() { x.engine._openOut(this, x.name); }; };\n      for (var i = 0; i < arr.length; i++) arr[i] = pack(arr[i]);\n      port._slip(_tryAny, [arr]);\n      port._resume();\n    }\n  }\n  _J.prototype.openMidiOut = function(arg) {\n    var port = new _M();\n    this._push(_refresh, []);\n    this._push(_openMidiOut, [port, arg]);\n    return port._thenable();\n  };\n  _J.prototype._openMidiOutNR = function(arg) {\n    var port = new _M();\n    this._push(_openMidiOut, [port, arg]);\n    return port._thenable();\n  };\n\n  function _openMidiIn(port, arg) {\n    if (this._bad) port._crash(this._err());\n    else {\n      var arr = _filterList(arg, _ins);\n      if (!arr.length) { _notFound(port, arg); return; }\n      var pack = function(x) { return function() { x.engine._openIn(this, x.name); }; };\n      for (var i = 0; i < arr.length; i++) arr[i] = pack(arr[i]);\n      port._slip(_tryAny, [arr]);\n      port._resume();\n    }\n  }\n  _J.prototype.openMidiIn = function(arg) {\n    var port = new _M();\n    this._push(_refresh, []);\n    this._push(_openMidiIn, [port, arg]);\n    return port._thenable();\n  };\n  _J.prototype._openMidiInNR = function(arg) {\n    var port = new _M();\n    this._push(_openMidiIn, [port, arg]);\n    return port._thenable();\n  };\n\n  function _onChange(watcher, arg) {\n    if (this._bad) watcher._crash();\n    else {\n      watcher._slip(_connectW, [arg]);\n      watcher._resume();\n    }\n  }\n  _J.prototype.onChange = function(arg) {\n    if (!this._orig._watcher) this._orig._watcher = new _W();\n    var watcher = this._orig._watcher._image();\n    this._push(_onChange, [watcher, arg]);\n    return watcher._thenable();\n  };\n\n  _J.prototype._close = function() {\n    _engine._close();\n  };\n\n  // _M: MIDI-In/Out object\n  function _M() {\n    _R.apply(this);\n    this._handles = [];\n    this._outs = [];\n  }\n  _M.prototype = new _R();\n  _M.prototype._filter = function(msg) {\n    if (this._orig._mpe) {\n      var out;\n      var outs = 0;\n      if (this._handles && this._handles.length) {\n        outs = this._handles.length;\n        out = this._handles[0];\n      }\n      if (this._outs && this._outs.length) {\n        outs = this._outs.length;\n        out = this._outs[0];\n      }\n      if (outs == 1 && !out._mpe) {\n        msg = this._orig._mpe.filter(msg);\n      }\n    }\n    return msg;\n  };\n  _M.prototype._receive = function(msg) { this._emit(this._filter(msg)); };\n  function _receive(msg) { if (!this._bad) this._receive(msg); }\n  _M.prototype.send = function() {\n    this._push(_receive, [MIDI.apply(null, arguments)]);\n    return this._thenable();\n  };\n  _M.prototype.note = function(c, n, v, t) {\n    this.noteOn(c, n, v);\n    if (typeof this._ch == 'undefined' && typeof this._master == 'undefined') {\n      if (t > 0) this.wait(t).noteOff(c, n);\n    }\n    else {\n      if (v > 0) this.wait(v).noteOff(c);\n    }\n    return this._thenable();\n  };\n  _M.prototype._emit = function(msg) {\n    var i;\n    for (i = 0; i < this._handles.length; i++) this._handles[i].apply(this, [MIDI(msg)._stamp(this)]);\n    for (i = 0; i < this._outs.length; i++) {\n      var m = MIDI(msg);\n      if (!m._stamped(this._outs[i])) this._outs[i].send(m._stamp(this));\n    }\n  };\n  function _emit(msg) { this._emit(msg); }\n  _M.prototype.emit = function(msg) {\n    this._push(_emit, [msg]);\n    return this._thenable();\n  };\n  function _connect(arg) {\n    if (_func(arg)) _push(this._orig._handles, arg);\n    else _push(this._orig._outs, arg);\n  }\n  function _disconnect(arg) {\n    if (typeof arg == 'undefined') {\n      this._orig._handles = [];\n      this._orig._outs = [];\n    }\n    else if (_func(arg)) _pop(this._orig._handles, arg);\n    else _pop(this._orig._outs, arg);\n  }\n  _M.prototype.connect = function(arg) {\n    this._push(_connect, [arg]);\n    return this._thenable();\n  };\n  _M.prototype.disconnect = function(arg) {\n    this._push(_disconnect, [arg]);\n    return this._thenable();\n  };\n  _M.prototype.connected = function() {\n    return this._orig._handles.length + this._orig._outs.length;\n  };\n  _M.prototype._image = function() {\n    var dup = this._dup();\n    dup._ch = this._ch;\n    dup._sxid = this._sxid;\n    dup._master = this._master;\n    dup._band = this._band;\n    return dup;\n  };\n  _M.prototype._ch = undefined;\n  _M.prototype._sxid = 0x7f;\n  _M.prototype._master = undefined;\n  _M.prototype._band = undefined;\n\n  _M.prototype.sxId = function(id) {\n    if (typeof id == 'undefined') id = _M.prototype._sxid;\n    if (id == this._sxid) return this._thenable();\n    id = _7b(id);\n    var img = this._image();\n    img._sxid = id;\n    this._push(_kick, [img]);\n    return img._thenable();\n  };\n  _M.prototype.ch = function(c) {\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this._thenable();\n    var img = this._image();\n    if (typeof c != 'undefined') c = _ch(c);\n    img._ch = c;\n    img._master = undefined;\n    img._band = undefined;\n    this._push(_kick, [img]);\n    return img._thenable();\n  };\n\n  function _mpe(m, n) {\n    if (!this._orig._mpe) this._orig._mpe = new MPE();\n    this._orig._mpe.setup(m, n);\n  }\n  _M.prototype.mpe = function(m, n) {\n    if (m == this._master && n == this._band || typeof m == 'undefined' && typeof this._master == 'undefined') return this._thenable();\n    if (typeof m != 'undefined') MPE.validate(m, n);\n    if (!n) return this.ch(m);\n    var img = this._image();\n    img._ch = undefined;\n    img._master = m;\n    img._band = n;\n    this._push(_mpe, [m, n]);\n    this._push(_kick, [img]);\n    return img._thenable();\n  };\n  function _validateChannel(c) {\n    if (c != parseInt(c) || c < 0 || c > 15)\n      throw RangeError('Bad channel value (must not be less than 0 or more than 15): ' + c);\n  }\n\n  // _W: Watcher object ~ MIDIAccess.onstatechange\n  function _W() {\n    _R.apply(this);\n    this._handles = [];\n    _rechain(this, _jzz, 'refresh');\n    _rechain(this, _jzz, 'openMidiOut');\n    _rechain(this, _jzz, 'openMidiIn');\n    _rechain(this, _jzz, 'onChange');\n    _rechain(this, _jzz, 'close');\n  }\n  _W.prototype = new _R();\n  function _connectW(arg) {\n    if (_func(arg)) {\n      if (!this._orig._handles.length) _engine._watch();\n      _push(this._orig._handles, arg);\n    }\n  }\n  function _disconnectW(arg) {\n    if (typeof arg == 'undefined') this._orig._handles = [];\n    else _pop(this._orig._handles, arg);\n    if (!this._orig._handles.length) _engine._unwatch();\n  }\n  _W.prototype.connect = function(arg) {\n    this._push(_connectW, [arg]);\n    return this._thenable();\n  };\n  _W.prototype.disconnect = function(arg) {\n    this._push(_disconnectW, [arg]);\n    return this._thenable();\n  };\n  function _changed(x0, y0, x1, y1) {\n    var i;\n    if (x0.length != x1.length || y0.length != y1.length) return true;\n    for (i = 0; i < x0.length; i++) if (x0[i].name != x1[i].name) return true;\n    for (i = 0; i < y0.length; i++) if (y0[i].name != y1[i].name) return true;\n    return false;\n  }\n  function _diff(x0, y0, x1, y1) {\n    if (!_changed(x0, y0, x1, y1)) return;\n    var ax = []; // added\n    var ay = [];\n    var rx = []; // removed\n    var ry = [];\n    var i;\n    var h = {};\n    for (i = 0; i < x0.length; i++) h[x0[i].name] = true;\n    for (i = 0; i < x1.length; i++) if (!h[x1[i].name]) ax.push(x1[i]);\n    h = {};\n    for (i = 0; i < x1.length; i++) h[x1[i].name] = true;\n    for (i = 0; i < x0.length; i++) if (!h[x0[i].name]) rx.push(x0[i]);\n    h = {};\n    for (i = 0; i < y0.length; i++) h[y0[i].name] = true;\n    for (i = 0; i < y1.length; i++) if (!h[y1[i].name]) ay.push(y1[i]);\n    h = {};\n    for (i = 0; i < y1.length; i++) h[y1[i].name] = true;\n    for (i = 0; i < y0.length; i++) if (!h[y0[i].name]) ry.push(y0[i]);\n    return { inputs: { added: ax, removed: rx }, outputs: { added: ay, removed: ry } };\n  }\n  function _fireW(arg) {\n    for (i = 0; i < _jzz._watcher._handles.length; i++) _jzz._watcher._handles[i].apply(_jzz, [arg]);\n  }\n\n  var _jzz;\n  var _engine = { _outs: [], _ins: [] };\n  var _virtual = { _outs: [], _ins: [] };\n\n  // // Node.js\n  // function _tryNODE() {\n  //   if (typeof module != 'undefined' && module.exports) {\n  //     var jazzmidi = require('jazz-midi');\n  //     if (jazzmidi) {\n  //       _initNode(jazzmidi);\n  //       return;\n  //     }\n  //   }\n  //   this._break();\n  // }\n  // Jazz-Plugin\n  function _tryJazzPlugin() {\n    var div = document.createElement('div');\n    div.style.visibility = 'hidden';\n    document.body.appendChild(div);\n    var obj = document.createElement('object');\n    obj.style.visibility = 'hidden';\n    obj.style.width = '0px'; obj.style.height = '0px';\n    obj.classid = 'CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90';\n    obj.type = 'audio/x-jazz';\n    document.body.appendChild(obj);\n    /* istanbul ignore next */\n    if (obj.isJazz) {\n      _initJazzPlugin(obj);\n      return;\n    }\n    this._break();\n  }\n\n  // Web MIDI API\n  var _navigator;\n  var _requestMIDIAccess;\n  function _findMidiAccess() {\n    if (typeof navigator !== 'undefined' && navigator.requestMIDIAccess) {\n      _navigator = navigator;\n      _requestMIDIAccess = navigator.requestMIDIAccess;\n      try {\n        if (_requestMIDIAccess.toString().indexOf('JZZ(') != -1) _requestMIDIAccess = undefined;\n      }\n      catch (err) {}\n    }\n  }\n  function _tryWebMIDI() {\n    _findMidiAccess();\n    if (_requestMIDIAccess) {\n      var self = this;\n      var onGood = function(midi) {\n        _initWebMIDI(midi);\n        self._resume();\n      };\n      var onBad = function(msg) {\n        self._crash(msg);\n      };\n      var opt = {};\n      _requestMIDIAccess.call(_navigator, opt).then(onGood, onBad);\n      this._pause();\n      return;\n    }\n    this._break();\n  }\n  function _tryWebMIDIsysex() {\n    _findMidiAccess();\n    if (_requestMIDIAccess) {\n      var self = this;\n      var onGood = function(midi) {\n        _initWebMIDI(midi, true);\n        self._resume();\n      };\n      var onBad = function(msg) {\n        self._crash(msg);\n      };\n      var opt = { sysex:true };\n      _requestMIDIAccess.call(_navigator, opt).then(onGood, onBad);\n      this._pause();\n      return;\n    }\n    this._break();\n  }\n\n  // Web-extension\n  function _tryCRX() {\n    var self = this;\n    var inst;\n    var msg;\n    function eventHandle(evt) {\n      inst = true;\n      var a = evt.detail;\n      if (!a) {\n        if (!msg) msg = document.getElementById('jazz-midi-msg');\n        if (!msg) return;\n        try { a = JSON.parse(msg.innerText); } catch (err) {}\n        msg.innerText = '';\n      }\n      document.removeEventListener('jazz-midi-msg', eventHandle);\n      if (a[0] === 'version') {\n        _initCRX(msg, a[2]);\n        self._resume();\n      }\n      else {\n        self._crash();\n      }\n    }\n    this._pause();\n    try {\n      document.addEventListener('jazz-midi-msg', eventHandle);\n      document.dispatchEvent(new Event('jazz-midi'));\n    }\n    catch (err) {}\n    setTimeout(function() { if (!inst) self._crash(); }, 50);\n  }\n\n  /* istanbul ignore next */\n  function _zeroBreak() {\n    this._pause();\n    var self = this;\n    _schedule(function() { self._crash(); });\n  }\n\n  function _filterEngines(opt) {\n    var ret = [];\n    var arr = _filterEngineNames(opt);\n    for (var i = 0; i < arr.length; i++) {\n      if (arr[i] == 'webmidi') {\n        if (opt && opt.sysex === true) ret.push(_tryWebMIDIsysex);\n        if (!opt || opt.sysex !== true || opt.degrade === true) ret.push(_tryWebMIDI);\n      }\n      //else if (arr[i] == 'node') { ret.push(_tryNODE); ret.push(_zeroBreak); }\n      else if (arr[i] == 'extension') ret.push(_tryCRX);\n      else if (arr[i] == 'plugin') ret.push(_tryJazzPlugin);\n    }\n    ret.push(_initNONE);\n    return ret;\n  }\n\n  function _filterEngineNames(opt) {\n    var web = ['node', 'extension', 'plugin', 'webmidi'];\n    if (!opt || !opt.engine) return web;\n    var arr = opt.engine instanceof Array ? opt.engine : [opt.engine];\n    var dup = {};\n    var none;\n    var etc;\n    var head = [];\n    var tail = [];\n    var i;\n    for (i = 0; i < arr.length; i++) {\n      var name = arr[i].toString().toLowerCase();\n      if (dup[name]) continue;\n      dup[name] = true;\n      if (name === 'none') none = true;\n      if (name === 'etc' || typeof name == 'undefined') etc = true;\n      if (etc) tail.push(name); else head.push(name);\n      _pop(web, name);\n    }\n    if (etc || head.length || tail.length) none = false;\n    return none ? [] : head.concat(etc ? web : tail);\n  }\n\n  function _initJZZ(opt) {\n    _jzz = new _J();\n    _jzz._options = opt;\n    _jzz._push(_tryAny, [_filterEngines(opt)]);\n    _jzz.refresh();\n    _jzz._resume();\n  }\n\n  function _initNONE() {\n    _engine._type = 'none';\n    _engine._version = _version;\n    _engine._sysex = true;\n    _engine._outs = [];\n    _engine._ins = [];\n    _engine._refresh = function() { _postRefresh(); };\n    _engine._watch = _nop;\n    _engine._unwatch = _nop;\n    _engine._close = _nop;\n  }\n  // common initialization for Jazz-Plugin and jazz-midi\n  function _initEngineJP() {\n    _engine._inArr = [];\n    _engine._outArr = [];\n    _engine._inMap = {};\n    _engine._outMap = {};\n    _engine._outsW = [];\n    _engine._insW = [];\n    _engine._version = _engine._main.version;\n    _engine._sysex = true;\n    var watcher;\n    function _closeAll() {\n      for (var i = 0; i < this.clients.length; i++) this._close(this.clients[i]);\n    }\n    _engine._refresh = function() {\n      _engine._outs = [];\n      _engine._ins = [];\n      var i, x;\n      for (i = 0; (x = _engine._main.MidiOutInfo(i)).length; i++) {\n        _engine._outs.push({ type: _engine._type, name: x[0], manufacturer: x[1], version: x[2] });\n      }\n      for (i = 0; (x = _engine._main.MidiInInfo(i)).length; i++) {\n        _engine._ins.push({ type: _engine._type, name: x[0], manufacturer: x[1], version: x[2] });\n      }\n      _postRefresh();\n    };\n    _engine._openOut = function(port, name) {\n      var impl = _engine._outMap[name];\n      if (!impl) {\n        if (_engine._pool.length <= _engine._outArr.length) _engine._pool.push(_engine._newPlugin());\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allOuts[name].manufacturer,\n            version: _engine._allOuts[name].version,\n            type: 'MIDI-out',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _close: function(port) { _engine._closeOut(port); },\n          _closeAll: _closeAll,\n          _receive: function(a) { if (a.length) this.plugin.MidiOutRaw(a.slice()); }\n        };\n        var plugin = _engine._pool[_engine._outArr.length];\n        impl.plugin = plugin;\n        _engine._outArr.push(impl);\n        _engine._outMap[name] = impl;\n      }\n      if (!impl.open) {\n        var s = impl.plugin.MidiOutOpen(name);\n        if (s !== name) {\n          if (s) impl.plugin.MidiOutClose();\n          port._break(); return;\n        }\n        impl.open = true;\n      }\n      port._orig._impl = impl;\n      _push(impl.clients, port._orig);\n      port._info = impl.info;\n      port._receive = function(arg) { impl._receive(arg); };\n      port._close = function() { impl._close(this); };\n    };\n    _engine._openIn = function(port, name) {\n      var impl = _engine._inMap[name];\n      if (!impl) {\n        if (_engine._pool.length <= _engine._inArr.length) _engine._pool.push(_engine._newPlugin());\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allIns[name].manufacturer,\n            version: _engine._allIns[name].version,\n            type: 'MIDI-in',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _close: function(port) { _engine._closeIn(port); },\n          _closeAll: _closeAll,\n          handle: function(t, a) {\n            for (var i = 0; i < this.clients.length; i++) {\n              var msg = MIDI(a);\n              this.clients[i]._emit(msg);\n            }\n          }\n        };\n        var makeHandle = function(x) { return function(t, a) { x.handle(t, a); }; };\n        impl.onmidi = makeHandle(impl);\n        var plugin = _engine._pool[_engine._inArr.length];\n        impl.plugin = plugin;\n        _engine._inArr.push(impl);\n        _engine._inMap[name] = impl;\n      }\n      if (!impl.open) {\n        var s = impl.plugin.MidiInOpen(name, impl.onmidi);\n        if (s !== name) {\n          if (s) impl.plugin.MidiInClose();\n          port._break(); return;\n        }\n        impl.open = true;\n      }\n      port._orig._impl = impl;\n      _push(impl.clients, port._orig);\n      port._info = impl.info;\n      port._close = function() { impl._close(this); };\n    };\n    _engine._closeOut = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length && impl.open) {\n        impl.open = false;\n        impl.plugin.MidiOutClose();\n      }\n    };\n    _engine._closeIn = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length && impl.open) {\n        impl.open = false;\n        impl.plugin.MidiInClose();\n      }\n    };\n    _engine._close = function() {\n      for (var i = 0; i < _engine._inArr.length; i++) if (_engine._inArr[i].open) _engine._inArr[i].plugin.MidiInClose();\n      _engine._unwatch();\n    };\n    _engine._watch = function() {\n      if (!watcher) watcher = setInterval(function() { _engine._refresh(); }, 250);\n    };\n    _engine._unwatch = function() {\n      if (watcher) clearInterval(watcher);\n      watcher = undefined;\n    };\n  }\n\n  function _initNode(obj) {\n    _engine._type = 'node';\n    _engine._main = obj;\n    _engine._pool = [];\n    _engine._newPlugin = function() { return new obj.MIDI(); };\n    _initEngineJP();\n  }\n  /* istanbul ignore next */\n  function _initJazzPlugin(obj) {\n    _engine._type = 'plugin';\n    _engine._main = obj;\n    _engine._pool = [obj];\n    _engine._newPlugin = function() {\n      var plg = document.createElement('object');\n      plg.style.visibility = 'hidden';\n      plg.style.width = '0px'; obj.style.height = '0px';\n      plg.classid = 'CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90';\n      plg.type = 'audio/x-jazz';\n      document.body.appendChild(plg);\n      return plg.isJazz ? plg : undefined;\n    };\n    _initEngineJP();\n  }\n  function _initWebMIDI(access, sysex) {\n    _engine._type = 'webmidi';\n    _engine._version = 43;\n    _engine._sysex = !!sysex;\n    _engine._access = access;\n    _engine._inMap = {};\n    _engine._outMap = {};\n    _engine._outsW = [];\n    _engine._insW = [];\n    var watcher;\n    function _closeAll() {\n      for (var i = 0; i < this.clients.length; i++) this._close(this.clients[i]);\n    }\n    _engine._refresh = function() {\n      _engine._outs = [];\n      _engine._ins = [];\n      _engine._access.outputs.forEach(function(port) {\n        _engine._outs.push({type: _engine._type, name: port.name, manufacturer: port.manufacturer, version: port.version});\n      });\n      _engine._access.inputs.forEach(function(port) {\n        _engine._ins.push({type: _engine._type, name: port.name, manufacturer: port.manufacturer, version: port.version});\n      });\n      _postRefresh();\n    };\n    _engine._openOut = function(port, name) {\n      var impl = _engine._outMap[name];\n      if (!impl) {\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allOuts[name].manufacturer,\n            version: _engine._allOuts[name].version,\n            type: 'MIDI-out',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _close: function(port) { _engine._closeOut(port); },\n          _closeAll: _closeAll,\n          _receive: function(a) { if (impl.dev && a.length) this.dev.send(a.slice()); }\n        };\n      }\n      var found;\n      _engine._access.outputs.forEach(function(dev) {\n        if (dev.name === name) found = dev;\n      });\n      if (found) {\n        impl.dev = found;\n        _engine._outMap[name] = impl;\n        port._orig._impl = impl;\n        _push(impl.clients, port._orig);\n        port._info = impl.info;\n        port._receive = function(arg) { impl._receive(arg); };\n        port._close = function() { impl._close(this); };\n        if (impl.dev.open) {\n          port._pause();\n          impl.dev.open().then(function() {\n            port._resume();\n          }, function() {\n            port._crash();\n          });\n        }\n      }\n      else port._break();\n    };\n    _engine._openIn = function(port, name) {\n      var impl = _engine._inMap[name];\n      if (!impl) {\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allIns[name].manufacturer,\n            version: _engine._allIns[name].version,\n            type: 'MIDI-in',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _close: function(port) { _engine._closeIn(port); },\n          _closeAll: _closeAll,\n          handle: function(evt) {\n            for (var i = 0; i < this.clients.length; i++) {\n              var msg = MIDI([].slice.call(evt.data));\n              this.clients[i]._emit(msg);\n            }\n          }\n        };\n      }\n      var found;\n      _engine._access.inputs.forEach(function(dev) {\n        if (dev.name === name) found = dev;\n      });\n      if (found) {\n        impl.dev = found;\n        var makeHandle = function(x) { return function(evt) { x.handle(evt); }; };\n        impl.dev.onmidimessage = makeHandle(impl);\n        _engine._inMap[name] = impl;\n        port._orig._impl = impl;\n        _push(impl.clients, port._orig);\n        port._info = impl.info;\n        port._close = function() { impl._close(this); };\n        if (impl.dev.open) {\n          port._pause();\n          impl.dev.open().then(function() {\n            port._resume();\n          }, function() {\n            port._crash();\n          });\n        }\n      }\n      else port._break();\n    };\n    _engine._closeOut = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length) {\n        if (impl.dev && impl.dev.close) impl.dev.close();\n        impl.dev = undefined;\n      }\n    };\n    _engine._closeIn = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length) {\n        if (impl.dev) {\n          impl.dev.onmidimessage = null;\n          if (impl.dev.close) impl.dev.close();\n        }\n        impl.dev = undefined;\n      }\n    };\n    _engine._close = function() {\n      _engine._unwatch();\n    };\n    _engine._watch = function() {\n      _engine._access.onstatechange = function() {\n        watcher = true;\n        _schedule(function() {\n          if (watcher) {\n            _engine._refresh();\n            watcher = false;\n          }\n        });\n      };\n    };\n    _engine._unwatch = function() {\n      _engine._access.onstatechange = undefined;\n    };\n  }\n  function _initCRX(msg, ver) {\n    _engine._type = 'extension';\n    _engine._version = ver;\n    _engine._sysex = true;\n    _engine._pool = [];\n    _engine._outs = [];\n    _engine._ins = [];\n    _engine._inArr = [];\n    _engine._outArr = [];\n    _engine._inMap = {};\n    _engine._outMap = {};\n    _engine._outsW = [];\n    _engine._insW = [];\n    _engine.refreshClients = [];\n    _engine._msg = msg;\n    _engine._newPlugin = function() {\n      var plugin = { id: _engine._pool.length };\n      _engine._pool.push(plugin);\n      if (!plugin.id) plugin.ready = true;\n      else document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['new'] }));\n    };\n    _engine._newPlugin();\n    _engine._refresh = function(client) {\n      _engine.refreshClients.push(client);\n      client._pause();\n      _schedule(function() {\n        document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['refresh'] }));\n      });\n    };\n    function _closeAll() {\n      for (var i = 0; i < this.clients.length; i++) this._close(this.clients[i]);\n    }\n    _engine._openOut = function(port, name) {\n      var impl = _engine._outMap[name];\n      if (!impl) {\n        if (_engine._pool.length <= _engine._outArr.length) _engine._newPlugin();\n        var plugin = _engine._pool[_engine._outArr.length];\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allOuts[name].manufacturer,\n            version: _engine._allOuts[name].version,\n            type: 'MIDI-out',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _start: function() { document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['openout', plugin.id, name] })); },\n          _close: function(port) { _engine._closeOut(port); },\n          _closeAll: _closeAll,\n          _receive: function(a) { if (a.length) { var v = a.slice(); v.splice(0, 0, 'play', plugin.id); document.dispatchEvent(new CustomEvent('jazz-midi', {detail: v})); } }\n        };\n        impl.plugin = plugin;\n        plugin.output = impl;\n        _engine._outArr.push(impl);\n        _engine._outMap[name] = impl;\n      }\n      port._orig._impl = impl;\n      _push(impl.clients, port._orig);\n      port._info = impl.info;\n      port._receive = function(arg) { impl._receive(arg); };\n      port._close = function() { impl._close(this); };\n      if (!impl.open) {\n        port._pause();\n        if (impl.plugin.ready) impl._start();\n      }\n    };\n    _engine._openIn = function(port, name) {\n      var impl = _engine._inMap[name];\n      if (!impl) {\n        if (_engine._pool.length <= _engine._inArr.length) _engine._newPlugin();\n        var plugin = _engine._pool[_engine._inArr.length];\n        impl = {\n          name: name,\n          clients: [],\n          info: {\n            name: name,\n            manufacturer: _engine._allIns[name].manufacturer,\n            version: _engine._allIns[name].version,\n            type: 'MIDI-in',\n            sysex: _engine._sysex,\n            engine: _engine._type\n          },\n          _start: function() { document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['openin', plugin.id, name] })); },\n          _close: function(port) { _engine._closeIn(port); },\n          _closeAll: _closeAll\n        };\n        impl.plugin = plugin;\n        plugin.input = impl;\n        _engine._inArr.push(impl);\n        _engine._inMap[name] = impl;\n      }\n      port._orig._impl = impl;\n      _push(impl.clients, port._orig);\n      port._info = impl.info;\n      port._close = function() { impl._close(this); };\n      if (!impl.open) {\n        port._pause();\n        if (impl.plugin.ready) impl._start();\n      }\n    };\n    _engine._closeOut = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length && impl.open) {\n        impl.open = false;\n        document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['closeout', impl.plugin.id] }));\n      }\n    };\n    _engine._closeIn = function(port) {\n      var impl = port._impl;\n      _pop(impl.clients, port._orig);\n      if (!impl.clients.length && impl.open) {\n        impl.open = false;\n        document.dispatchEvent(new CustomEvent('jazz-midi', { detail: ['closein', impl.plugin.id] }));\n      }\n    };\n    _engine._close = function() {\n      _engine._unwatch();\n    };\n    var watcher;\n    _engine._watch = function() {\n      _engine._insW = _engine._ins;\n      _engine._outsW = _engine._outs;\n      watcher = setInterval(function() {\n        document.dispatchEvent(new CustomEvent('jazz-midi', {detail:['refresh']}));\n      }, 250);\n    };\n    _engine._unwatch = function() {\n      clearInterval(watcher);\n      watcher = undefined;\n    };\n    document.addEventListener('jazz-midi-msg', function(evt) {\n      var i, j, impl;\n      var v = evt.detail ? [ evt.detail ] : undefined;\n      if (!v) {\n        v = _engine._msg.innerText.split('\\n');\n        _engine._msg.innerText = '';\n        for (i = 0; i < v.length; i++) try { v[i] = JSON.parse(v[i]); } catch (err) { v[i] = []; }\n      }\n      for (i = 0; i < v.length; i++) {\n        var a = v[i];\n        if (!a.length) continue;\n        if (a[0] === 'refresh') {\n          if (a[1].ins) {\n            for (j = 0; j < a[1].ins.length; j++) a[1].ins[j].type = _engine._type;\n            _engine._ins = a[1].ins;\n          }\n          if (a[1].outs) {\n            for (j = 0; j < a[1].outs.length; j++) a[1].outs[j].type = _engine._type;\n            _engine._outs = a[1].outs;\n          }\n          _postRefresh();\n          for (j = 0; j < _engine.refreshClients.length; j++) _engine.refreshClients[j]._resume();\n          _engine.refreshClients = [];\n        }\n        else if (a[0] === 'version') {\n          var plugin = _engine._pool[a[1]];\n          if (plugin) {\n            plugin.ready = true;\n            if (plugin.input) plugin.input._start();\n            if (plugin.output) plugin.output._start();\n          }\n        }\n        else if (a[0] === 'openout') {\n          impl = _engine._pool[a[1]].output;\n          if (impl) {\n            if (a[2] == impl.name) {\n              impl.open = true;\n              if (impl.clients) for (j = 0; j < impl.clients.length; j++) impl.clients[j]._resume();\n            }\n            else if (impl.clients) for (j = 0; j < impl.clients.length; j++) impl.clients[j]._crash();\n          }\n        }\n        else if (a[0] === 'openin') {\n          impl = _engine._pool[a[1]].input;\n          if (impl) {\n            if (a[2] == impl.name) {\n              impl.open = true;\n              if (impl.clients) for (j = 0; j < impl.clients.length; j++) impl.clients[j]._resume();\n            }\n            else if (impl.clients) for (j = 0; j < impl.clients.length; j++) impl.clients[j]._crash();\n          }\n        }\n        else if (a[0] === 'midi') {\n          impl = _engine._pool[a[1]].input;\n          if (impl && impl.clients) {\n            for (j = 0; j < impl.clients.length; j++) {\n              var msg = MIDI(a.slice(3));\n              impl.clients[j]._emit(msg);\n            }\n          }\n        }\n      }\n    });\n  }\n\n  var JZZ = function(opt) {\n    if (!_jzz) _initJZZ(opt);\n    return _jzz._thenable();\n  };\n  JZZ.JZZ = JZZ;\n  JZZ.version = _version;\n  JZZ.info = function() { return _J.prototype.info(); };\n\n  function Widget(arg) {\n    var self = new _M();\n    if (arg instanceof Object) _for(arg, function(k) { self[k] = arg[k]; });\n    self._resume();\n    return self;\n  }\n  JZZ.Widget = Widget;\n  _J.prototype.Widget = JZZ.Widget;\n  JZZ.addMidiIn = function(name, widget) {\n    var info = _clone(widget._info || {});\n    info.name = name;\n    info.type = info.type || 'javascript';\n    info.manufacturer = info.manufacturer || 'virtual';\n    info.version = info.version || '0.0';\n    var engine = {\n      _info: function() { return info; },\n      _openIn: function(port) {\n        port._pause();\n        port._info = _clone(info);\n        port._close = function() { widget.disconnect(port); };\n        widget.connect(port);\n        port._resume();\n      }\n    };\n    return JZZ.lib.registerMidiIn(name, engine);\n  };\n  JZZ.addMidiOut = function(name, widget) {\n    var info = _clone(widget._info || {});\n    info.name = name;\n    info.type = info.type || 'javascript';\n    info.manufacturer = info.manufacturer || 'virtual';\n    info.version = info.version || '0.0';\n    var engine = {\n      _info: function() { return info; },\n      _openOut: function(port) {\n        port._pause();\n        port._info = _clone(info);\n        port._close = function() { port.disconnect(); };\n        _connect.apply(port, [widget]);\n        port._resume();\n      }\n    };\n    return JZZ.lib.registerMidiOut(name, engine);\n  };\n\n  // JZZ.SMPTE\n\n  function SMPTE() {\n    var self = this instanceof SMPTE ? this : self = new SMPTE();\n    SMPTE.prototype.reset.apply(self, arguments);\n    return self;\n  }\n  SMPTE.prototype.reset = function(arg) {\n    if (arg instanceof SMPTE) {\n      this.setType(arg.getType());\n      this.setHour(arg.getHour());\n      this.setMinute(arg.getMinute());\n      this.setSecond(arg.getSecond());\n      this.setFrame(arg.getFrame());\n      this.setQuarter(arg.getQuarter());\n      return this;\n    }\n    var arr = arg instanceof Array ? arg : arguments;\n    this.setType(arr[0]);\n    this.setHour(arr[1]);\n    this.setMinute(arr[2]);\n    this.setSecond(arr[3]);\n    this.setFrame(arr[4]);\n    this.setQuarter(arr[5]);\n    return this;\n  };\n  function _fixDropFrame() { if (this.type == 29.97 && !this.second && this.frame < 2 && this.minute % 10) this.frame = 2; }\n  SMPTE.prototype.isFullFrame = function() { return this.quarter == 0 || this.quarter == 4; };\n  SMPTE.prototype.getType = function() { return this.type; };\n  SMPTE.prototype.getHour = function() { return this.hour; };\n  SMPTE.prototype.getMinute = function() { return this.minute; };\n  SMPTE.prototype.getSecond = function() { return this.second; };\n  SMPTE.prototype.getFrame = function() { return this.frame; };\n  SMPTE.prototype.getQuarter = function() { return this.quarter; };\n  SMPTE.prototype.setType = function(x) {\n    if (typeof x == 'undefined' || x == 24) this.type = 24;\n    else if (x == 25) this.type = 25;\n    else if (x == 29.97) { this.type = 29.97; _fixDropFrame.apply(this); }\n    else if (x == 30) this.type = 30;\n    else throw RangeError('Bad SMPTE frame rate: ' + x);\n    if (this.frame >= this.type) this.frame = this.type - 1; // could not be more than 29\n    return this;\n  };\n  SMPTE.prototype.setHour = function(x) {\n    if (typeof x == 'undefined') x = 0;\n    if (x != parseInt(x) || x < 0 || x >= 24) throw RangeError('Bad SMPTE hours value: ' + x);\n    this.hour = x;\n    return this;\n  };\n  SMPTE.prototype.setMinute = function(x) {\n    if (typeof x == 'undefined') x = 0;\n    if (x != parseInt(x) || x < 0 || x >= 60) throw RangeError('Bad SMPTE minutes value: ' + x);\n    this.minute = x;\n    _fixDropFrame.apply(this);\n    return this;\n  };\n  SMPTE.prototype.setSecond = function(x) {\n    if (typeof x == 'undefined') x = 0;\n    if (x != parseInt(x) || x < 0 || x >= 60) throw RangeError('Bad SMPTE seconds value: ' + x);\n    this.second = x;\n    _fixDropFrame.apply(this);\n    return this;\n  };\n  SMPTE.prototype.setFrame = function(x) {\n    if (typeof x == 'undefined') x = 0;\n    if (x != parseInt(x) || x < 0 || x >= this.type) throw RangeError('Bad SMPTE frame number: ' + x);\n    this.frame = x;\n    _fixDropFrame.apply(this);\n    return this;\n  };\n  SMPTE.prototype.setQuarter = function(x) {\n    if (typeof x == 'undefined') x = 0;\n    if (x != parseInt(x) || x < 0 || x >= 8) throw RangeError('Bad SMPTE quarter frame: ' + x);\n    this.quarter = x;\n    return this;\n  };\n  SMPTE.prototype.incrFrame = function() {\n    this.frame++;\n    if (this.frame >= this.type) {\n      this.frame = 0;\n      this.second++;\n      if (this.second >= 60) {\n        this.second = 0;\n        this.minute++;\n        if (this.minute >= 60) {\n          this.minute = 0;\n          this.hour = this.hour >= 23 ? 0 : this.hour + 1;\n        }\n      }\n    }\n    _fixDropFrame.apply(this);\n    return this;\n  };\n  SMPTE.prototype.decrFrame = function() {\n    if (!this.second && this.frame == 2 && this.type == 29.97 && this.minute % 10) this.frame = 0; // drop-frame\n    this.frame--;\n    if (this.frame < 0) {\n      this.frame = this.type == 29.97 ? 29 : this.type - 1;\n      this.second--;\n      if (this.second < 0) {\n        this.second = 59;\n        this.minute--;\n        if (this.minute < 0) {\n          this.minute = 59;\n          this.hour = this.hour ? this.hour - 1 : 23;\n        }\n      }\n    }\n    return this;\n  };\n  SMPTE.prototype.incrQF = function() {\n    this.backwards = false;\n    this.quarter = (this.quarter + 1) & 7;\n    if (this.quarter == 0 || this.quarter == 4) this.incrFrame();\n    return this;\n  };\n  SMPTE.prototype.decrQF = function() {\n    this.backwards = true;\n    this.quarter = (this.quarter + 7) & 7;\n    if (this.quarter == 3 || this.quarter == 7) this.decrFrame();\n    return this;\n  };\n  function _825(a) { return [[24, 25, 29.97, 30][(a[7] >> 1) & 3], ((a[7] & 1) << 4) | a[6], (a[5] << 4) | a[4], (a[3] << 4) | a[2], (a[1] << 4) | a[0]]; }\n  SMPTE.prototype.read = function(m) {\n    if (!(m instanceof MIDI)) m = MIDI.apply(null, arguments);\n    if (m[0] == 0xf0 && m[1] == 0x7f && m[3] == 1 && m[4] == 1 && m[9] == 0xf7) {\n      this.type = [24, 25, 29.97, 30][(m[5] >> 5) & 3];\n      this.hour = m[5] & 31;\n      this.minute = m[6];\n      this.second = m[7];\n      this.frame = m[8];\n      this.quarter = 0;\n      this._ = undefined;\n      this._b = undefined;\n      this._f = undefined;\n      return true;\n    }\n    if (m[0] == 0xf1 && typeof m[1] != 'undefined') {\n      var q = m[1] >> 4;\n      var n = m[1] & 15;\n      if (q == 0) {\n        if (this._ == 7) {\n          if (this._f == 7) {\n            this.reset(_825(this._a));\n            this.incrFrame();\n          }\n          this.incrFrame();\n        }\n      }\n      else if (q == 3) {\n        if (this._ == 4) {\n          this.decrFrame();\n        }\n      }\n      else if (q == 4) {\n        if (this._ == 3) {\n          this.incrFrame();\n        }\n      }\n      else if (q == 7) {\n        if (this._ === 0) {\n          if (this._b === 0) {\n            this.reset(_825(this._a));\n            this.decrFrame();\n          }\n          this.decrFrame();\n        }\n      }\n      if (!this._a) this._a = [];\n      this._a[q] = n;\n      this._f = this._f === q - 1 || q == 0 ? q : undefined;\n      this._b = this._b === q + 1 || q == 7 ? q : undefined;\n      this._ = q;\n      this.quarter = q;\n      return true;\n    }\n    return false;\n  };\n  function _mtc(t) {\n    if (!t.backwards && t.quarter >= 4) t.decrFrame(); // continue encoding previous frame\n    else if (t.backwards && t.quarter < 4) t.incrFrame();\n    var ret;\n    switch (t.quarter >> 1) {\n      case 0: ret = t.frame; break;\n      case 1: ret = t.second; break;\n      case 2: ret = t.minute; break;\n      default: ret = t.hour;\n    }\n    if (t.quarter & 1) ret >>= 4;\n    else ret &= 15;\n    if (t.quarter == 7) {\n      if (t.type == 25) ret |= 2;\n      else if (t.type == 29.97) ret |= 4;\n      else if (t.type == 30) ret |= 6;\n    }\n    // restore original t\n    if (!t.backwards && t.quarter >= 4) t.incrFrame();\n    else if (t.backwards && t.quarter < 4) t.decrFrame();\n    return ret | (t.quarter << 4);\n  }\n  function _hrtype(t) {\n    if (t.type == 25) return t.hour | 0x20;\n    if (t.type == 29.97) return t.hour | 0x40;\n    if (t.type == 30) return t.hour | 0x60;\n    return t.hour;\n  }\n  function _dec(x) { return x < 10 ? '0' + x : x; }\n  function _smptetxt(x) {\n    var arr = [];\n    for (var i = 0; i < x.length; i++) arr[i] = _dec(i ? x[i] : x[i] & 0x1f);\n    return arr.join(':');\n  }\n  SMPTE.prototype.toString = function() { return _smptetxt([this.hour, this.minute, this.second, this.frame]); };\n  JZZ.SMPTE = SMPTE;\n  _J.prototype.SMPTE = SMPTE;\n\n  // JZZ.MIDI\n\n  function MIDI(arg) {\n    var self = this instanceof MIDI ? this : self = new MIDI();\n    var i;\n    if (arg instanceof MIDI) {\n      self._from = arg._from.slice();\n      _for(arg, function(i) { if (i != '_from') self[i] = arg[i]; });\n      return self;\n    }\n    else self._from = [];\n    if (typeof arg == 'undefined') return self;\n    var arr = arg instanceof Array ? arg : arguments;\n    for (i = 0; i < arr.length; i++) {\n      n = arr[i];\n      if (i == 1) {\n        if (self[0] >= 0x80 && self[0] <= 0xAF) n = MIDI.noteValue(n);\n        if (self[0] >= 0xC0 && self[0] <= 0xCF) n = MIDI.programValue(n);\n      }\n      if (n != parseInt(n) || n < 0 || n > 255) _throw(arr[i]);\n      self.push(n);\n    }\n    return self;\n  }\n  MIDI.prototype = [];\n  MIDI.prototype.constructor = MIDI;\n  var _noteNum = {};\n  MIDI.noteValue = function(x) { return typeof x == 'undefined' ? undefined : _noteNum[x.toString().toLowerCase()]; };\n  MIDI.programValue = function(x) { return x; };\n  MIDI.octaveValue = function(x) {\n    var n = _noteNum[x.toString().toLowerCase()];\n    if (typeof n == 'undefined') n = _noteNum[x.toString().toLowerCase() + '1'];\n    return typeof n == 'undefined' ? undefined : n % 12;\n  };\n  MIDI.freq = function(n, a) {\n    if (typeof a == 'undefined') a = 440.0;\n    _float(a);\n    if (n != parseFloat(n)) n = _7bn(n);\n    return (a * Math.pow(2, (n - 69.0) / 12.0));\n  };\n  function _float(x) { if (x != parseFloat(x)) throw TypeError('Not a number: ' + x); }\n  MIDI.shift = function(f, f0) {\n    if (typeof f0 == 'undefined') f0 = 440;\n    _float(f);\n    _float(f0);\n    return Math.log2(f / f0) * 12;\n  };\n  MIDI.midi = function(f, f0) {\n    if (f != parseFloat(f)) return _7bn(f);\n    return MIDI.shift(f, f0) + 69;\n  };\n  MIDI.to7b = function(x) {\n    _float(x);\n    return x <= 0 ? 0 : x >= 1 ? 0x7f : Math.floor(x * 0x80);\n  };\n  MIDI.to14b = function(x) {\n    _float(x);\n    return x <= 0 ? 0 : x >= 1 ? 0x3fff : Math.floor(x * 0x4000);\n  };\n  MIDI.to21b = function(x) {\n    if (typeof x == 'undefined') return 0x1fffff;\n    _float(x);\n    if (x <= 0) return 0;\n    x = (Math.floor(x) << 14) + MIDI.to14b(x - Math.floor(x));\n    return x < 0x1fffff ? x : 0x1ffffe;\n  };\n  function _MIDI() {}\n  _MIDI.prototype = MIDI;\n  MIDI._sxid = 0x7f;\n  MIDI.sxId = function(id) {\n    if (typeof id == 'undefined') id = MIDI._sxid;\n    if (id == this._sxid) return this;\n    id = _7b(id);\n    var ret = new _MIDI();\n    ret._ch = this._ch;\n    ret._sxid = id;\n    return ret;\n  };\n  MIDI.ch = function(c) {\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this;\n    var ret = new _MIDI();\n    if (typeof c != 'undefined') c = _ch(c);\n    ret._ch = c;\n    ret._sxid = this._sxid;\n    return ret;\n  };\n\n  var _noteMap = { c:0, d:2, e:4, f:5, g:7, a:9, b:11, h:11 };\n  _for(_noteMap, function(k) {\n    for (n = 0; n < 12; n++) {\n      m = _noteMap[k] + n * 12;\n      if (m > 127) break;\n      _noteNum[k + n] = m; _noteNum[k + '♮' + n] = m;\n      if (m > 0) {\n        _noteNum[k + 'b' + n] = m - 1; _noteNum[k + '♭' + n] = m - 1;\n        _noteNum[k + 'bb' + n] = m - 2; _noteNum[k + '♭♭' + n] = m - 2; _noteNum[k + '𝄫' + n] = m - 2;\n      }\n      if (m < 127) {\n        _noteNum[k + '#' + n] = m + 1; _noteNum[k + '♯' + n] = m + 1;\n        _noteNum[k + '##' + n] = m + 2; _noteNum[k + '♯♯' + n] = m + 2; _noteNum[k + '𝄪' + n] = m + 2;\n      }\n    }\n  });\n  for (n = 0; n < 128; n++) _noteNum[n] = n;\n  function _throw(x) { throw RangeError('Bad MIDI value: ' + x); }\n  function _bad(x) { throw TypeError('Invalid value: ' + x); }\n  function _oor(x) { throw RangeError('Out of range: ' + x); }\n  function _ch(c) { _validateChannel(c); return parseInt(c); }\n  function _7b(n, m) { if (n != parseInt(n) || n < 0 || n > 0x7f) _throw(typeof m == 'undefined' ? n : m); return parseInt(n); }\n  function _8b(n) { if (n != parseInt(n) || n < 0 || n > 0xff) _throw(n); return parseInt(n); }\n  function _14b(n) { if (n != parseInt(n) || n < 0 || n > 0x3fff) _throw(n); return parseInt(n); }\n  function _16b(n) { if (n != parseInt(n) || n < 0 || n > 0xffff) throw RangeError('Expected a 16-bit value: ' + n); return parseInt(n); }\n  function _21b(n) { if (n != parseInt(n) || n < 0 || n > 0x1fffff) _throw(n); return parseInt(n); }\n  function _7bn(n) { return _7b(MIDI.noteValue(n), n); }\n  function _lsb(n) { return _14b(n) & 0x7f; }\n  function _msb(n) { return _14b(n) >> 7; }\n  function _8bs(s) { s = '' + s; for (var i = 0; i < s.length; i++) if (s.charCodeAt(i) > 255) _throw(s[i]); return s; }\n  function _to777(n) { return [n >> 14, (n >> 7) & 0x7f, n & 0x7f]; }\n  function _01(x, y) {\n    if (x != parseFloat(x)) _bad(typeof y == 'undefined' ? x : y);\n    if (x < 0 || x > 1) _oor(typeof y == 'undefined' ? x : y);\n    return parseFloat(x);\n }\n  function _rt(b) { return typeof b != 'undefined' && !b ? 0x7E : 0x7F; }\n  function _ntu(x) {\n    var k, m;\n    var kkk = [];\n    var vvv = {};\n    _for(x, function(k) {\n      m = _21b(x[k]);\n      k = _7bn(k);\n      if (k in vvv) throw RangeError('Duplicate MIDI value: ' + k);\n      kkk.push(k);\n      vvv[k] = m;\n    });\n    kkk.sort();\n    var out = [kkk.length];\n    for (k = 0; k < kkk.length; k++) out = out.concat([kkk[k]], _to777(vvv[kkk[k]]));\n    return out;\n  }\n  function _f2ntu(x) {\n    var out = {};\n    _for (x, function(k) { out[k] = MIDI.to21b(x[k] == parseFloat(x[k]) ? x[k] : _7bn(x[k])); });\n    return out;\n  }\n  function _hz2ntu(x) {\n    var out = {};\n    _for (x, function(k) { out[k] = MIDI.to21b(MIDI.midi(x[k])); });\n    return out;\n  }\n  function _12x7(a) {\n    var out = [];\n    if (!(a instanceof Array) || a.length != 12) throw TypeError('Expected an array of size 12');\n    for (var i = 0; i < 12; i++) out.push(_7b(a[i]));\n    return out;\n  }\n  function _12x14(a) {\n    var out = [];\n    if (!(a instanceof Array) || a.length != 12) throw TypeError('Expected an array of size 12');\n    for (var i = 0; i < 12; i++) {\n      out.push(_msb(a[i]));\n      out.push(_lsb(a[i]));\n    }\n    return out;\n  }\n  var _helperMPE = {\n    noteOff: function(c, n, v) { if (typeof v == 'undefined') v = 64; return [0x80 + _ch(c), _7bn(n), _7b(v)]; },\n    noteOn: function(c, n, v) { if (typeof v == 'undefined') v = 127; return [0x90 + _ch(c), _7bn(n), _7b(v)]; },\n    aftertouch: function(c, n, v) { return [0xA0 + _ch(c), _7bn(n), _7b(v)]; },\n  };\n  var _helperCH = {\n    control: function(c, n, v) { return [0xB0 + _ch(c), _7b(n), _7b(v)]; },\n    program: function(c, n) { return [0xC0 + _ch(c), _7b(MIDI.programValue(n), n)]; },\n    pressure: function(c, n) { return [0xD0 + _ch(c), _7b(n)]; },\n    pitchBend: function(c, n, l) { return typeof l == 'undefined' ? [0xE0 + _ch(c), _lsb(n), _msb(n)] : [0xE0 + _ch(c), _7b(l), _7b(n)]; },\n    pitchBendF: function(c, x) { return _helperCH.pitchBend(c, MIDI.to14b((x + 1) / 2)); },\n    bankMSB: function(c, n) { return [0xB0 + _ch(c), 0x00, _7b(n)]; },\n    bankLSB: function(c, n) { return [0xB0 + _ch(c), 0x20, _7b(n)]; },\n    modMSB: function(c, n) { return [0xB0 + _ch(c), 0x01, _7b(n)]; },\n    modLSB: function(c, n) { return [0xB0 + _ch(c), 0x21, _7b(n)]; },\n    breathMSB: function(c, n) { return [0xB0 + _ch(c), 0x02, _7b(n)]; },\n    breathLSB: function(c, n) { return [0xB0 + _ch(c), 0x22, _7b(n)]; },\n    footMSB: function(c, n) { return [0xB0 + _ch(c), 0x04, _7b(n)]; },\n    footLSB: function(c, n) { return [0xB0 + _ch(c), 0x24, _7b(n)]; },\n    portamentoMSB: function(c, n) { return [0xB0 + _ch(c), 0x05, _7b(n)]; },\n    portamentoLSB: function(c, n) { return [0xB0 + _ch(c), 0x25, _7b(n)]; },\n    dataMSB: function(c, n) { return [0xB0 + _ch(c), 0x06, _7b(n)]; },\n    dataLSB: function(c, n) { return [0xB0 + _ch(c), 0x26, _7b(n)]; },\n    volumeMSB: function(c, n) { return [0xB0 + _ch(c), 0x07, _7b(n)]; },\n    volumeLSB: function(c, n) { return [0xB0 + _ch(c), 0x27, _7b(n)]; },\n    balanceMSB: function(c, n) { return [0xB0 + _ch(c), 0x08, _7b(n)]; },\n    balanceLSB: function(c, n) { return [0xB0 + _ch(c), 0x28, _7b(n)]; },\n    panMSB: function(c, n) { return [0xB0 + _ch(c), 0x0A, _7b(n)]; },\n    panLSB: function(c, n) { return [0xB0 + _ch(c), 0x2A, _7b(n)]; },\n    expressionMSB: function(c, n) { return [0xB0 + _ch(c), 0x0B, _7b(n)]; },\n    expressionLSB: function(c, n) { return [0xB0 + _ch(c), 0x2B, _7b(n)]; },\n    damper: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x40, b ? 127 : 0]; },\n    portamento: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x41, b ? 127 : 0]; },\n    sostenuto: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x42, b ? 127 : 0]; },\n    soft: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x43, b ? 127 : 0]; },\n    legato: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x44, b ? 127 : 0]; },\n    hold2: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x45, b ? 127 : 0]; },\n    soundVariation: function(c, n) { return [0xB0 + _ch(c), 0x46, _7bn(n)]; },\n    filterResonance: function(c, n) { return [0xB0 + _ch(c), 0x47, _7bn(n)]; },\n    releaseTime: function(c, n) { return [0xB0 + _ch(c), 0x48, _7bn(n)]; },\n    attackTime: function(c, n) { return [0xB0 + _ch(c), 0x49, _7bn(n)]; },\n    brightness: function(c, n) { return [0xB0 + _ch(c), 0x4A, _7bn(n)]; },\n    decayTime: function(c, n) { return [0xB0 + _ch(c), 0x4B, _7bn(n)]; },\n    vibratoRate: function(c, n) { return [0xB0 + _ch(c), 0x4C, _7bn(n)]; },\n    vibratoDepth: function(c, n) { return [0xB0 + _ch(c), 0x4D, _7bn(n)]; },\n    vibratoDelay: function(c, n) { return [0xB0 + _ch(c), 0x4E, _7bn(n)]; },\n    ptc: function(c, n) { return [0xB0 + _ch(c), 0x54, _7bn(n)]; },\n    dataIncr: function(c) { return [0xB0 + _ch(c), 0x60, 0]; },\n    dataDecr: function(c) { return [0xB0 + _ch(c), 0x61, 0]; },\n    nrpnLSB: function(c, n) { return [0xB0 + _ch(c), 0x62, _7b(n)]; },\n    nrpnMSB: function(c, n) { return [0xB0 + _ch(c), 0x63, _7b(n)]; },\n    rpnLSB: function(c, n) { return [0xB0 + _ch(c), 0x64, _7b(n)]; },\n    rpnMSB: function(c, n) { return [0xB0 + _ch(c), 0x65, _7b(n)]; },\n    allSoundOff: function(c) { return [0xB0 + _ch(c), 0x78, 0]; },\n    resetAllControllers: function(c) { return [0xB0 + _ch(c), 0x79, 0]; },\n    localControl: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), 0x7a, b ? 127 : 0]; },\n    allNotesOff: function(c) { return [0xB0 + _ch(c), 0x7b, 0]; },\n    omni: function(c, b) { if (typeof b == 'undefined') b = true; return [0xB0 + _ch(c), b ? 0x7d : 0x7c, 0]; },\n    mono: function(c, n) { if (typeof n == 'undefined') n = 1; return [0xB0 + _ch(c), 0x7e, _7b(n)]; },\n    poly: function(c) { return [0xB0 + _ch(c), 0x7f, 0]; },\n  };\n  function _splitMasterTuning(a, b, c, d) {\n    if (typeof b != 'undefined') return [_7b(a), _7b(b), _7b(c), _7b(d)];\n    if (a != parseInt(a) || a < 0 || n > 0xffff) _bad(a);\n    a = parseInt(a);\n    return [(a >> 12) & 0xf, (a >> 8) & 0xf, (a >> 4) & 0xf, a & 0xf];\n  }\n  function _gsxg12b(x) { // -1 <= x <= 1\n    _float(x);\n    return Math.round(x * 1000 + 0x400);\n  }\n  var _helperNC = { // no channel\n    mtc: function(t) { return [0xF1, _mtc(t)]; },\n    songPosition: function(n, l) { return typeof l == 'undefined' ? [0xF2, _lsb(n), _msb(n)] : [0xF2, _7b(l), _7b(n)]; },\n    songSelect: function(n) { return [0xF3, _7b(n)]; },\n    tune: function() { return [0xF6]; },\n    clock: function() { return [0xF8]; },\n    start: function() { return [0xFA]; },\n    continue: function() { return [0xFB]; },\n    stop: function() { return [0xFC]; },\n    active: function() { return [0xFE]; },\n    sxIdRequest: function() { return [0xF0, 0x7E, this._sxid, 0x06, 0x01, 0xF7]; },\n    sxTuningDumpRequest: function(n, k) { return typeof k == 'undefined' ?\n      [0xF0, 0x7E, this._sxid, 0x08, 0x00, _7b(n), 0xF7] : [0xF0, 0x7E, this._sxid, 0x08, 0x03, _7b(n), _7b(k), 0xF7]; },\n    sxFullFrame: function(t) { return [0xF0, 0x7F, this._sxid, 0x01, 0x01, _hrtype(t), t.getMinute(), t.getSecond(), t.getFrame(), 0xF7]; },\n    sxMasterVolume: function(n, l) { return typeof l == 'undefined' ?\n      [0xF0, 0x7F, this._sxid, 0x04, 0x01, _lsb(n), _msb(n), 0xF7] : [0xF0, 0x7F, this._sxid, 0x04, 0x01, _7b(l), _7b(n), 0xF7]; },\n    sxMasterVolumeF: function(x) { return _helperNC.sxMasterVolume.call(this, MIDI.to14b(_01(x))); },\n    sxMasterFineTuning: function(n, l) { return typeof l == 'undefined' ?\n      [0xF0, 0x7F, this._sxid, 0x04, 0x03, _lsb(n), _msb(n), 0xF7] : [0xF0, 0x7F, this._sxid, 0x04, 0x03, _7b(l), _7b(n), 0xF7]; },\n    sxMasterFineTuningF: function(x) { return _helperNC.sxMasterFineTuning.call(this, MIDI.to14b(_01((x % 1 + 1) / 2, x))); },\n    sxMasterCoarseTuning: function(n) { return [0xF0, 0x7F, this._sxid, 0x04, 0x04, 0x00, _7b(n), 0xF7]; },\n    sxMasterCoarseTuningF: function(x) { return _helperNC.sxMasterCoarseTuning.call(this, 0x40 + (x - x % 1)); },\n    sxNoteTuning: function(a, b, c, d) { return b == parseInt(b) ?\n      [0xF0, _rt(d), this._sxid, 0x08, 0x07, _7b(a), _7b(b)].concat(_ntu(c), [0xF7]) :\n      [0xF0, 0x7F, this._sxid, 0x08, 0x02, _7b(a)].concat(_ntu(b), [0xF7]); },\n    sxNoteTuningF: function(a, b, c, d) { return b == parseInt(b) ?\n      _helperNC.sxNoteTuning.call(this, a, b, _f2ntu(c), d) : _helperNC.sxNoteTuning.call(this, a, _f2ntu(b)); },\n    sxNoteTuningHZ: function(a, b, c, d) { return b == parseInt(b) ?\n      _helperNC.sxNoteTuning.call(this, a, b, _hz2ntu(c), d) : _helperNC.sxNoteTuning.call(this, a, _hz2ntu(b)); },\n    sxScaleTuning1: function(a, b, c) { return a == parseInt(a) ?\n      [0xF0, _rt(c), this._sxid, 0x08, 0x08].concat(_to777(_16b(a)), _12x7(b), [0xF7]) :\n      _helperNC.sxScaleTuning1.call(this, 0xffff, a, b); },\n    sxScaleTuning1F: function(a, b, c) { if (a != parseInt(a)) return _helperNC.sxScaleTuning1F.call(this, 0xffff, a, b);\n      var v = []; for (var i = 0; i < b.length; i++) {\n        if (b[i] < -0.64 || b[i] > 0.63) throw RangeError('Out of range: ' + b[i]);\n        v.push(Math.floor(b[i] * 100 + 64)); }\n      return _helperNC.sxScaleTuning1.call(this, a, v, c); },\n    sxScaleTuning2: function(a, b, c) { return a == parseInt(a) ?\n      [0xF0, _rt(c), this._sxid, 0x08, 0x09].concat(_to777(_16b(a)), _12x14(b), [0xF7]) :\n      _helperNC.sxScaleTuning2.call(this, 0xffff, a, b); },\n    sxScaleTuning2F: function(a, b, c) { if (a != parseInt(a)) return _helperNC.sxScaleTuning2F.call(this, 0xffff, a, b);\n      var v = []; for (var i = 0; i < b.length; i++) {\n        var x = (b[i] + 1) / 2;\n        if (x < -1 || x > 1) throw RangeError('Out of range: ' + b[i]);\n        v.push(MIDI.to14b((b[i] + 1) / 2)); }\n      return _helperNC.sxScaleTuning2.call(this, a, v, c); },\n    sxGM: function(gm) { if (typeof gm == 'undefined') gm = 1; return [0xF0, 0x7E, this._sxid, 0x09, gm ? gm == 2 ? 3 : 1 : 2, 0xf7]; },\n    sxGS: function(arg) { var arr = typeof arg == 'undefined' ? [0x40, 0, 0x7F, 0] : arg instanceof Array ? arg : arguments;\n      var c = 0; var a = [0xF0, 0x41, this._sxid, 0x42, 0x12];\n      for (var i = 0; i < arr.length; i++) { var x = _7b(arr[i]); a.push(x); c += x; }\n      c %= 128; a.push(c ? 128 - c : 0); a.push(0xf7); return a; },\n    sxXG: function(arg) { var arr = typeof arg == 'undefined' ? [0, 0, 0x7E, 0] : arg instanceof Array ? arg : arguments;\n      var sxid = this._sxid == 0x7f ? 0 : this._sxid;\n      if (sxid > 15) _throw('Bad Yamaha device number: ' + sxid);\n      var a = [0xf0, 0x43, 16 + sxid, 0x4c];\n      for (var i = 0; i < arr.length; i++) a.push(_7b(arr[i])); a.push(0xf7); return a; },\n    sxMidiSoft: function(n, s) {\n      var a = [0xf0, 0x00, 0x20, 0x24, 0x00, _7b(n || 0)];\n      s = typeof s == 'undefined' ? '' : '' + s;\n      for (var i = 0; i < s.length; i++) a.push(_7b(s.charCodeAt(i)));\n      a.push(0xf7); return a; },\n    gsMasterVolume: function(n) { return _helperNC.sxGS.call(this, [0x40, 0, 4, _7b(n)]); },\n    gsMasterVolumeF: function(x) { return _helperNC.gsMasterVolume.call(this, MIDI.to7b(_01(x))); },\n    gsMasterFineTuning: function(a, b, c, d) { a = _splitMasterTuning(a, b, c, d); return _helperNC.sxGS.call(this, [0x40, 0, 0, a[0], a[1], a[2], a[3]]); },\n    gsMasterFineTuningF: function(x) { return _helperNC.gsMasterFineTuning.call(this, _gsxg12b(x % 1)); },\n    gsMasterCoarseTuning: function(n) { return _helperNC.sxGS.call(this, [0x40, 0, 5, _7b(n)]); },\n    gsMasterCoarseTuningF: function(x) { return _helperNC.gsMasterCoarseTuning.call(this, 0x40 + (x - x % 1)); },\n    gsOctaveTuning: function(c, n, x) { return _helperNC.sxGS.call(this, [0x40, 0x10 + [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 11, 12, 13, 14, 15][_ch(c)], 0x40 + MIDI.octaveValue(n), _7b(x)]); },\n    gsOctaveTuningF: function(c, n, x) { if (x < -0.64 || x > 0.63) throw RangeError('Out of range: ' + x);\n      return _helperNC.gsOctaveTuning.call(this, c, n, Math.floor(x * 100 + 64)); },\n    xgMasterVolume: function(n) { return _helperNC.sxXG.call(this, [0, 0, 4, _7b(n)]); },\n    xgMasterVolumeF: function(x) { return _helperNC.xgMasterVolume.call(this, MIDI.to7b(_01(x))); },\n    xgMasterFineTuning: function(a, b, c, d) { a = _splitMasterTuning(a, b, c, d); return _helperNC.sxXG.call(this, [0, 0, 0, a[0], a[1], a[2], a[3]]); },\n    xgMasterFineTuningF: function(x) { return _helperNC.xgMasterFineTuning.call(this, _gsxg12b(x % 1)); },\n    xgMasterCoarseTuning: function(n) { return _helperNC.sxXG.call(this, [0, 0, 6, _7b(n)]); },\n    xgMasterCoarseTuningF: function(x) { return _helperNC.xgMasterCoarseTuning.call(this, 0x40 + (x - x % 1)); },\n    xgOctaveTuning: function(c, n, x) { return _helperNC.sxXG.call(this, [8, _ch(c), 0x41 + MIDI.octaveValue(n), _7b(x)]); },\n    xgOctaveTuningF: function(c, n, x) { if (x < -0.64 || x > 0.63) throw RangeError('Out of range: ' + x);\n      return _helperNC.xgOctaveTuning.call(this, c, n, Math.floor(x * 100 + 64)); },\n    reset: function() { return [0xFF]; },\n  };\n  _helperNC.sxScaleTuning = _helperNC.sxScaleTuning2;\n  _helperNC.sxScaleTuningF = _helperNC.sxScaleTuning2F;\n  _helperNC.sxMasterTranspose = _helperNC.sxMasterCoarseTuning;\n  _helperNC.sxMasterTransposeF = _helperNC.sxMasterCoarseTuningF;\n  _helperNC.gsMasterTranspose = _helperNC.gsMasterCoarseTuning;\n  _helperNC.gsMasterTransposeF = _helperNC.gsMasterCoarseTuningF;\n  _helperNC.xgMasterTranspose = _helperNC.xgMasterCoarseTuning;\n  _helperNC.xgMasterTransposeF = _helperNC.xgMasterCoarseTuningF;\n  var _helperGCH = { // compound messages\n    bank: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.bankMSB(c, _msb(m)), _helperCH.bankLSB(c, _lsb(m))] : [_helperCH.bankMSB(c, m), _helperCH.bankLSB(c, l)]; },\n    modF: function(c, x) { return _helperGCH.mod(c, MIDI.to14b(x)); },\n    mod: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.modMSB(c, _msb(m)), _helperCH.modLSB(c, _lsb(m))] : [_helperCH.modMSB(c, m), _helperCH.modLSB(c, l)]; },\n    breathF: function(c, x) { return _helperGCH.breath(c, MIDI.to14b(x)); },\n    breath: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.breathMSB(c, _msb(m)), _helperCH.breathLSB(c, _lsb(m))] : [_helperCH.breathMSB(c, m), _helperCH.breathLSB(c, l)]; },\n    footF: function(c, x) { return _helperGCH.foot(c, MIDI.to14b(x)); },\n    foot: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.footMSB(c, _msb(m)), _helperCH.footLSB(c, _lsb(m))] : [_helperCH.footMSB(c, m), _helperCH.footLSB(c, l)]; },\n    portamentoTimeF: function(c, x) { return _helperGCH.portamentoTime(c, MIDI.to14b(x)); },\n    portamentoTime: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.portamentoMSB(c, _msb(m)), _helperCH.portamentoLSB(c, _lsb(m))] : [_helperCH.portamentoMSB(c, m), _helperCH.portamentoLSB(c, l)]; },\n    dataF: function(c, x) { return _helperGCH.data(c, MIDI.to14b(x)); },\n    data: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.dataMSB(c, _msb(m)), _helperCH.dataLSB(c, _lsb(m))] : [_helperCH.dataMSB(c, m), _helperCH.dataLSB(c, l)]; },\n    volumeF: function(c, x) { return _helperGCH.volume(c, MIDI.to14b(x)); },\n    volume: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.volumeMSB(c, _msb(m)), _helperCH.volumeLSB(c, _lsb(m))] : [_helperCH.volumeMSB(c, m), _helperCH.volumeLSB(c, l)]; },\n    balanceF: function(c, x) { return _helperGCH.balance(c, MIDI.to14b((x + 1) / 2)); },\n    balance: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.balanceMSB(c, _msb(m)), _helperCH.balanceLSB(c, _lsb(m))] : [_helperCH.balanceMSB(c, m), _helperCH.balanceLSB(c, l)]; },\n    panF: function(c, x) { return _helperGCH.pan(c, MIDI.to14b((x + 1) / 2)); },\n    pan: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.panMSB(c, _msb(m)), _helperCH.panLSB(c, _lsb(m))] : [_helperCH.panMSB(c, m), _helperCH.panLSB(c, l)]; },\n    expressionF: function(c, x) { return _helperGCH.expression(c, MIDI.to14b(x)); },\n    expression: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.expressionMSB(c, _msb(m)), _helperCH.expressionLSB(c, _lsb(m))] : [_helperCH.expressionMSB(c, m), _helperCH.expressionLSB(c, l)]; },\n    nrpn: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.nrpnMSB(c, _msb(m)), _helperCH.nrpnLSB(c, _lsb(m))] : [_helperCH.nrpnMSB(c, m), _helperCH.nrpnLSB(c, l)]; },\n    rpn: function(c, m, l) { return typeof l == 'undefined' ?\n      [_helperCH.rpnMSB(c, _msb(m)), _helperCH.rpnLSB(c, _lsb(m))] : [_helperCH.rpnMSB(c, m), _helperCH.rpnLSB(c, l)]; },\n    rpnPitchBendRange: function(c, m, l) { return _helperGCH.rpn(c, 0, 0).concat(_helperGCH.data(c, m, l)); },\n    rpnPitchBendRangeF: function(c, x) { return _helperGCH.rpnPitchBendRange(c, _7b(x - x % 1), Math.floor((x % 1) * 100)); },\n    rpnFineTuning: function(c, m, l) { return _helperGCH.rpn(c, 0, 1).concat(_helperGCH.data(c, m, l)); },\n    rpnFineTuningF: function(c, x) { return _helperGCH.rpn(c, 0, 1).concat(_helperGCH.dataF(c, (x % 1 + 1) / 2)); },\n    rpnCoarseTuning: function(c, m) { return _helperGCH.rpn(c, 0, 2).concat([_helperCH.dataMSB(c, m)]); },\n    rpnCoarseTuningF: function(c, x) { return _helperGCH.rpn(c, 0, 2).concat([_helperCH.dataMSB(c, 0x40 + (x - x % 1))]); },\n    rpnTuning: function(c, n, m, l) { return _helperGCH.rpnCoarseTuning(c, n).concat(_helperGCH.rpnFineTuning(c, m, l)); },\n    rpnTuningF: function(c, x) { return _helperGCH.rpnCoarseTuningF(c, x).concat(_helperGCH.rpnFineTuningF(c, x)); },\n    rpnTuningA: function(c, a) { return _helperGCH.rpnTuningF(c, MIDI.shift(a)); },\n    rpnSelectTuningProgram: function(c, n) { return _helperGCH.rpn(c, 0, 3).concat([_helperCH.dataMSB(c, n)]); },\n    rpnSelectTuningBank: function(c, n) { return _helperGCH.rpn(c, 0, 4).concat([_helperCH.dataMSB(c, n)]); },\n    rpnSelectTuning: function(c, n, k) { return typeof k == 'undefined' ?\n      _helperGCH.rpnSelectTuningProgram(c, n) : _helperGCH.rpnSelectTuningBank(c, n).concat(_helperGCH.rpnSelectTuningProgram(c, k)); },\n    rpnModulationDepthRange: function(c, m, l) { return _helperGCH.rpn(c, 0, 5).concat(_helperGCH.data(c, m, l)); },\n    rpnModulationDepthRangeF: function(c, x) { return _helperGCH.rpnModulationDepthRange(c, _7b(x - x % 1), Math.floor((x % 1) * 128)); },\n    rpnNull: function(c) { return _helperGCH.rpn(c, 0x7f, 0x7f); },\n    mode1: function(c) { return [ _helperCH.omni(c, true), _helperCH.poly(c) ]; },\n    mode2: function(c) { return [ _helperCH.omni(c, true), _helperCH.mono(c) ]; },\n    mode3: function(c) { return [ _helperCH.omni(c, false), _helperCH.poly(c) ]; },\n    mode4: function(c) { return [ _helperCH.omni(c, false), _helperCH.mono(c) ]; },\n  };\n  var _helperGNC = { // compound messages no channel\n    sxMasterTuning: function(n, m, l) { return [_helperNC.sxMasterCoarseTuning.call(this, n), _helperNC.sxMasterFineTuning.call(this, m, l)]; },\n    sxMasterTuningF: function(x) { return [_helperNC.sxMasterCoarseTuningF.call(this, x), _helperNC.sxMasterFineTuningF.call(this, x)]; },\n    gsMasterTuningF: function(x) { return [_helperNC.gsMasterCoarseTuningF.call(this, x), _helperNC.gsMasterFineTuningF.call(this, x)]; },\n    xgMasterTuningF: function(x) { return [_helperNC.xgMasterCoarseTuningF.call(this, x), _helperNC.xgMasterFineTuningF.call(this, x)]; },\n    sxMasterTuningA: function(a) { return _helperGNC.sxMasterTuningF.call(this, MIDI.shift(a)); },\n    gsMasterTuningA: function(a) { return _helperGNC.gsMasterTuningF.call(this, MIDI.shift(a)); },\n    xgMasterTuningA: function(a) { return _helperGNC.xgMasterTuningF.call(this, MIDI.shift(a)); },\n    gsScaleTuning: function(c, a) { var out = []; if (a.length != 12) throw RangeError('Wrong input size: ' + a.length);\n      for (var i = 0; i < 12; i++) out.push(_helperNC.gsOctaveTuning.call(this, c, i, a[i])); return out; },\n    gsScaleTuningF: function(c, a) { var out = []; if (a.length != 12) throw RangeError('Wrong input size: ' + a.length);\n      for (var i = 0; i < 12; i++) out.push(_helperNC.gsOctaveTuningF.call(this, c, i, a[i])); return out; },\n    xgScaleTuning: function(c, a) { var out = []; if (a.length != 12) throw RangeError('Wrong input size: ' + a.length);\n      for (var i = 0; i < 12; i++) out.push(_helperNC.xgOctaveTuning.call(this, c, i, a[i])); return out; },\n    xgScaleTuningF: function(c, a) { var out = []; if (a.length != 12) throw RangeError('Wrong input size: ' + a.length);\n      for (var i = 0; i < 12; i++) out.push(_helperNC.xgOctaveTuningF.call(this, c, i, a[i])); return out; },\n  };\n  function _smf(ff, dd) {\n    var midi = new MIDI();\n    midi.ff = _8b(ff);\n    midi.dd = typeof dd == 'undefined' ? '' : _8bs(dd);\n    return midi;\n  }\n  var _helperSMF = { // Standard MIDI File events\n    smf: function(arg) {\n      if (arg instanceof MIDI) return new MIDI(arg);\n      var arr = arg instanceof Array ? arg : arguments;\n      var ff = _8b(arr[0]);\n      var dd = '';\n      if (arr.length == 2) dd = _2s(arr[1]);\n      else if (arr.length > 2) dd = _2s(Array.prototype.slice.call(arr, 1));\n      return _smf(ff, dd);\n    },\n    smfSeqNumber: function(dd) {\n      if (dd == parseInt(dd)) {\n        if (dd < 0 || dd > 0xffff) throw RangeError('Sequence number out of range: ' + dd);\n        dd = String.fromCharCode(dd >> 8) + String.fromCharCode(dd & 0xff);\n      }\n      else {\n        dd = '' + dd;\n        if (dd.length == 0) dd = '\\x00\\x00';\n        else if (dd.length == 1) dd = '\\x00' + dd;\n        else if (dd.length > 2) throw RangeError('Sequence number out of range' + _smftxt(dd));\n      }\n      return _smf(0, dd);\n    },\n    smfText: function(dd) { return _smf(1, JZZ.lib.toUTF8(dd)); },\n    smfCopyright: function(dd) { return _smf(2, JZZ.lib.toUTF8(dd)); },\n    smfSeqName: function(dd) { return _smf(3, JZZ.lib.toUTF8(dd)); },\n    smfInstrName: function(dd) { return _smf(4, JZZ.lib.toUTF8(dd)); },\n    smfLyric: function(dd) { return _smf(5, JZZ.lib.toUTF8(dd)); },\n    smfMarker: function(dd) { return _smf(6, JZZ.lib.toUTF8(dd)); },\n    smfCuePoint: function(dd) { return _smf(7, JZZ.lib.toUTF8(dd)); },\n    smfProgName: function(dd) { return _smf(8, JZZ.lib.toUTF8(dd)); },\n    smfDevName: function(dd) { return _smf(9, JZZ.lib.toUTF8(dd)); },\n    smfChannelPrefix: function(dd) {\n      if (dd == parseInt(dd)) {\n        _validateChannel(dd);\n        dd = String.fromCharCode(dd);\n      }\n      else {\n        dd = '' + dd;\n        if (dd.length == 0) dd = '\\x00';\n        else if (dd.length > 1 || dd.charCodeAt(0) > 15) throw RangeError('Channel number out of range' + _smftxt(dd));\n      }\n      return _smf(32, dd);\n    },\n    smfMidiPort: function(dd) {\n      if (dd == parseInt(dd)) {\n        if (dd < 0 || dd > 127) throw RangeError('Port number out of range: ' + dd);\n        dd = String.fromCharCode(dd);\n      }\n      else {\n        dd = '' + dd;\n        if (dd.length == 0) dd = '\\x00';\n        else if (dd.length > 1 || dd.charCodeAt(0) > 127) throw RangeError('Port number out of range' + _smftxt(dd));\n      }\n      return _smf(33, dd);\n    },\n    smfEndOfTrack: function(dd) {\n      if (_2s(dd) != '') throw RangeError('Unexpected data' + _smftxt(_2s(dd)));\n      return _smf(47);\n    },\n    smfTempo: function(dd) { // microseconds per quarter note\n      if (('' + dd).length == 3) return _smf(81, dd);\n      if (dd == parseInt(dd) && dd > 0 && dd <= 0xffffff) {\n        return _smf(81, String.fromCharCode(dd >> 16) + String.fromCharCode((dd >> 8) & 0xff) + String.fromCharCode(dd & 0xff));\n      }\n      throw RangeError('Out of range' + _smftxt(_2s(dd)));\n    },\n    smfBPM: function(bpm) { return _helperSMF.smfTempo(Math.round(60000000.0 / bpm)); },\n    smfSMPTE: function(dd) {\n      if (dd instanceof SMPTE) return _smf(84, String.fromCharCode(dd.hour) + String.fromCharCode(dd.minute) + String.fromCharCode(dd.second) + String.fromCharCode(dd.frame) + String.fromCharCode((dd.quarter % 4) * 25));\n      var s = '' + dd;\n      if (s.length == 5) {\n        return _smf(84, dd);\n      }\n      var arr = dd instanceof Array ? dd : Array.prototype.slice.call(arguments);\n      arr.splice(0, 0, 30);\n      return _helperSMF.smfSMPTE(new SMPTE(arr));\n    },\n    smfTimeSignature: function(a, b, c, d) {\n      var nn, dd, cc, bb;\n      var m = ('' + a ).match(/^\\s*(\\d+)\\s*\\/\\s*(\\d+)\\s*$/);\n      if (m) {\n        nn = parseInt(m[1]);\n        dd = parseInt(m[2]);\n        if (nn > 0 && nn < 0x100 && dd > 0 && !(dd & (dd - 1))) {\n          cc = dd; dd = 0;\n          for (cc >>= 1; cc; cc >>= 1) dd++;\n          cc = b == parseInt(b) ? b : 24;\n          bb = c == parseInt(c) ? c : 8;\n          return _smf(88, String.fromCharCode(nn) + String.fromCharCode(dd) + String.fromCharCode(cc) + String.fromCharCode(bb));\n        }\n        else if (('' + a ).length == 4) return _smf(88, a);\n      }\n      else if (a == parseInt(a) && b == parseInt(b)) {\n        if (a > 0 && a < 0x100 && b > 0 && !(b & (b - 1))) {\n          nn = a;\n          dd = 0;\n          cc = b;\n          for (cc >>= 1; cc; cc >>= 1) dd++;\n          cc = c == parseInt(c) ? c : 24;\n          bb = d == parseInt(d) ? d : 8;\n          return _smf(88, String.fromCharCode(nn) + String.fromCharCode(dd) + String.fromCharCode(cc) + String.fromCharCode(bb));\n        }\n        else if (('' + a ).length == 4) return _smf(88, a);\n        a = a + '/' + b;\n      }\n      else if (('' + a ).length == 4) return _smf(88, a);\n      throw RangeError('Wrong time signature' + _smftxt(_2s('' + a)));\n    },\n    smfKeySignature: function(dd) {\n      dd = '' + dd;\n      var m = dd.match(/^\\s*([A-H][b#]?)\\s*(|maj|major|dur|m|min|minor|moll)\\s*$/i);\n      if (m) {\n        var sf = {\n          CB: 0, GB: 1, DB: 2, AB: 3, EB: 4, BB: 5, F: 6, C: 7, G: 8, D: 9, A: 10,\n          E:11, B: 12, H: 12, 'F#': 13, 'C#': 14, 'G#': 15, 'D#': 16, 'A#': 17\n        }[m[1].toUpperCase()];\n        var mi = { '': 0, MAJ: 0, MAJOR: 0, DUR: 0, M: 1, MIN: 1, MINOR: 1, MOLL: 1}[m[2].toUpperCase()];\n        if (typeof sf != 'undefined' && typeof mi != 'undefined') {\n          if (mi) sf -= 3;\n          sf -= 7;\n          if (sf >= -7 && sf < 0) dd = String.fromCharCode(256 + sf) + String.fromCharCode(mi);\n          else if (sf >= 0 && sf <= 7) dd = String.fromCharCode(sf) + String.fromCharCode(mi);\n        }\n      }\n      if (dd.length == 2 && dd.charCodeAt(1) <= 1 && (dd.charCodeAt(0) <= 7 || dd.charCodeAt(0) <= 255 && dd.charCodeAt(0) >= 249)) return _smf(89, dd);\n      throw RangeError('Incorrect key signature' + _smftxt(dd));\n    },\n    smfSequencer: function(dd) { return _smf(127, _2s(dd)); }\n  };\n\n  var _helpers = {};\n  function _copyHelperNC(name, func) {\n    MIDI[name] = function() { return new MIDI(func.apply(this, arguments)); };\n    _helpers[name] = function() { return this.send(func.apply(this, arguments)); };\n  }\n  function _copyHelperSMF(name, func) {\n    MIDI[name] = function() { return func.apply(this, arguments); };\n    _helpers[name] = function() { return this.send(func.apply(this, arguments)); };\n  }\n  function _copyHelperGNC(name, func) {\n    MIDI[name] = function() {\n      var i;\n      var g = [];\n      var a = func.apply(this, arguments);\n      for (i = 0; i < a.length; i++) g.push(new MIDI(a[i]));\n      return g;\n    };\n    _helpers[name] = function() {\n      var a = func.apply(this, arguments);\n      var g = this;\n      for (var i = 0; i < a.length; i++) g = g.send(a[i]);\n      return g;\n    };\n  }\n  function _copyHelperMPE(name, func) {\n    MIDI[name] = function() {\n      return new MIDI(func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments))));\n    };\n    _helpers[name] = function() {\n      if (typeof this._master != 'undefined') {\n        var msg = new MIDI(func.apply(this, [this._master].concat(Array.prototype.slice.call(arguments))));\n        msg._mpe = msg[1];\n        return this.send(msg);\n      }\n      return this.send(func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments))));\n    };\n  }\n  function _copyHelperCH(name, func) {\n    MIDI[name] = function() {\n      return new MIDI(func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments))));\n    };\n    _helpers[name] = function() {\n      if (typeof this._master != 'undefined') {\n        var chan;\n        var args = Array.prototype.slice.call(arguments);\n        if (args.length < func.length) args = [this._master].concat(args);\n        else {\n          chan = _7bn(args[0]);\n          args[0] = this._master;\n        }\n        var msg = new MIDI(func.apply(this, args));\n        msg._mpe = chan;\n        return this.send(msg);\n      }\n      return this.send(func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments))));\n    };\n  }\n  function _copyHelperGCH(name, func) {\n    MIDI[name] = function() {\n      var i;\n      var g = [];\n      var a = func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments)));\n      for (i = 0; i < a.length; i++) g.push(new MIDI(a[i]));\n      return g;\n    };\n    _helpers[name] = function() {\n      var i;\n      var a;\n      var g;\n      if (typeof this._master != 'undefined') {\n        var chan;\n        var args = Array.prototype.slice.call(arguments);\n        if (args.length < func.length) args = [this._master].concat(args);\n        else {\n          chan = _7bn(args[0]);\n          args[0] = this._master;\n        }\n        a = func.apply(this, args);\n        g = this;\n        for (i = 0; i < a.length; i++) {\n          var msg = MIDI(a[i]);\n          msg._mpe = chan;\n          g = g.send(msg);\n        }\n        return g;\n      }\n      a = func.apply(this, typeof this._ch == 'undefined' ? arguments : [this._ch].concat(Array.prototype.slice.call(arguments)));\n      g = this;\n      for (i = 0; i < a.length; i++) g = g.send(a[i]);\n      return g;\n    };\n  }\n\n  _for(_helperNC, function(n) { _copyHelperNC(n, _helperNC[n]); });\n  _for(_helperSMF, function(n) { _copyHelperSMF(n, _helperSMF[n]); });\n  _for(_helperGNC, function(n) { _copyHelperGNC(n, _helperGNC[n]); });\n  _for(_helperMPE, function(n) { _copyHelperMPE(n, _helperMPE[n]); });\n  _for(_helperCH, function(n) { _copyHelperCH(n, _helperCH[n]); });\n  _for(_helperGCH, function(n) { _copyHelperGCH(n, _helperGCH[n]); });\n\n  function _copyMidiHelpers(M) {\n    _for(_helpers, function(n) { M.prototype[n] = _helpers[n]; });\n  }\n  _copyMidiHelpers(_M);\n\n  var _channelMap = { a:10, b:11, c:12, d:13, e:14, f:15, A:10, B:11, C:12, D:13, E:14, F:15 };\n  for (k = 0; k < 16; k++) _channelMap[k] = k;\n  MIDI.prototype.getChannel = function() {\n    if (this.ff == 0x20 && this.dd.length == 1 && this.dd.charCodeAt(0) < 16) return this.dd.charCodeAt(0);\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0xef) return;\n    return c & 15;\n  };\n  MIDI.prototype.setChannel = function(x) {\n    x = _channelMap[x];\n    if (typeof x == 'undefined') return this;\n    if (this.ff == 0x20) this.dd = String.fromCharCode(x);\n    else {\n      var c = this[0];\n      if (typeof c != 'undefined' && c >= 0x80 && c <= 0xef) this[0] = (c & 0xf0) | x;\n    }\n    return this;\n  };\n  MIDI.prototype.getNote = function() {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0xaf) return;\n    return this[1];\n  };\n  MIDI.prototype.setNote = function(x) {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0xaf) return this;\n    x = MIDI.noteValue(x);\n    if (typeof x != 'undefined') this[1] = x;\n    return this;\n  };\n  MIDI.prototype.getVelocity = function() {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0x9f) return;\n    return this[2];\n  };\n  MIDI.prototype.setVelocity = function(x) {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0x9f) return this;\n    x = parseInt(x);\n    if (x >= 0 && x < 128) this[2] = x;\n    return this;\n  };\n  MIDI.prototype.getSysExId = function() {\n    if (this[0] == 0xf0) return this[2];\n  };\n  MIDI.prototype.setSysExId = function(x) {\n    if (this[0] == 0xf0 && this.length > 2) {\n      x = parseInt(x);\n      if (x >= 0 && x < 128) this[2] = x;\n    }\n    return this;\n  };\n  MIDI.prototype.getData = function() {\n    if (typeof this.dd != 'undefined') return this.dd.toString();\n  };\n  MIDI.prototype.setData = function(dd) {\n    this.dd = _2s(dd);\n    return this;\n  };\n  function _is_yamaha_smf(ff, dd) { return ff == 0x7f && typeof dd != 'undefined' && dd.charCodeAt(0) == 0x43 && dd.charCodeAt(1) == 0x7b; }\n  function _is_yamaha_chord(ff, dd) { return _is_yamaha_smf(ff, dd) && dd.charCodeAt(2) == 1; }\n  function _yamaha_chord(a, b) {\n    if (a >= 0 && a <= 0x7f && b >= 0 && b <= 0x7f) {\n      var c = a & 0xf;\n      var d = a >> 4;\n      if (c > 0 && c < 8 && d < 7) c = ['C', 'D', 'E', 'F', 'G', 'A', 'B'][c - 1] + ['bbb', 'bb', 'b', '', '#', '##', '###'][d];\n      else return '-';\n      if (b > 34) return c + '?';\n      else return c + [\n        '', '6', 'Maj7', 'Maj7(#11)', '(9)', 'Maj7(9)', '6(9)', 'aug', 'm', 'm6', 'm7', 'm7b5',\n        'm(9)', 'm7(9)', 'm7(11)', 'm+7', 'm+7(9)', 'dim', 'dim7', '7', '7sus4', '7b5', '7(9)',\n        '7(#11)', '7(13)', '7(b9)', '7(b13)', '7(#9)', 'Maj7aug', '7aug', '1+8', '1+5', 'sus4', '1+2+5', 'cc'][b];\n    }\n    return '-';\n  }\n  MIDI.prototype.getText = function() {\n    if (typeof this.dd != 'undefined') {\n      if (_is_yamaha_chord(this.ff, this.dd)) return _yamaha_chord(this.dd.charCodeAt(3), this.dd.charCodeAt(4));\n      else return JZZ.lib.fromUTF8(this.dd);\n    }\n    if (this.isMidiSoft()) {\n      var s = [];\n      for (var i = 6; i < this.length - 1; i++) s.push(String.fromCharCode(this[i]));\n      return s.join('');\n    }\n  };\n  MIDI.prototype.setText = function(dd) {\n    this.dd = JZZ.lib.toUTF8(dd);\n    return this;\n  };\n  MIDI.prototype.getTempo = function() {\n    if (this.ff == 0x51 && typeof this.dd != 'undefined') {\n      return this.dd.charCodeAt(0) * 65536 + this.dd.charCodeAt(1) * 256 + this.dd.charCodeAt(2);\n    }\n  };\n  MIDI.prototype.getBPM = function() {\n    var ms = this.getTempo();\n    if (ms) return 60000000 / ms;\n  };\n  MIDI.prototype.getTimeSignature = function() {\n    if (this.ff == 0x58 && typeof this.dd != 'undefined') {\n       return [this.dd.charCodeAt(0), 1 << this.dd.charCodeAt(1)];\n    }\n  };\n  MIDI.prototype.getKeySignature = function() {\n    if (this.ff == 0x59 && typeof this.dd != 'undefined') {\n      var sf = this.dd.charCodeAt(0);\n      var mi = this.dd.charCodeAt(1);\n      if (sf & 0x80) sf = sf - 0x100;\n      if (sf >= -7 && sf <= 7 && mi >= 0 && mi <= 1) {\n        return [sf,\n          ['Cb', 'Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F', 'C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'G#', 'D#', 'A#'][mi ? sf + 10 : sf + 7],\n          !!mi\n        ];\n      }\n    }\n  };\n\n  MIDI.prototype.isNoteOn = function() {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x90 || c > 0x9f) return false;\n    return this[2] > 0 ? true : false;\n  };\n  MIDI.prototype.isNoteOff = function() {\n    var c = this[0];\n    if (typeof c == 'undefined' || c < 0x80 || c > 0x9f) return false;\n    if (c < 0x90) return true;\n    return this[2] == 0 ? true : false;\n  };\n  MIDI.prototype.isSysEx = function() {\n    return this[0] == 0xf0;\n  };\n  MIDI.prototype.isFullSysEx = function() {\n    return this[0] == 0xf0 && this[this.length - 1] == 0xf7;\n  };\n  MIDI.prototype.isMidiSoft = function() {\n    return this.isFullSysEx() && this[1] == 0 && this[2] == 0x20 && this[3] == 0x24 && this[4] == 0;\n  };\n  MIDI.prototype.isSMF = function() {\n    return this.ff >= 0 && this.ff <= 0x7f;\n  };\n  MIDI.prototype.isEOT = function() {\n    return this.ff == 0x2f;\n  };\n  MIDI.prototype.isTempo = function() {\n    return this.ff == 0x51;\n  };\n  MIDI.prototype.isTimeSignature = function() {\n    return this.ff == 0x58;\n  };\n  MIDI.prototype.isKeySignature = function() {\n    return this.ff == 0x59;\n  };\n  MIDI.prototype.isGmReset = function() {\n    return this.match([0xf0, 0x7e, [0, 0], 0x09, [0, 0], 0xf7]);\n  };\n  MIDI.prototype.isGsReset = function() {\n    return this.match([0xf0, 0x41, [0, 0], 0x42, 0x12, 0x40, 0, 0x7f, 0, 0x41, 0xf7]);\n  };\n  MIDI.prototype.isXgReset = function() {\n    return this.match([0xf0, 0x43, [0x10, 0xf0], 0x4c, 0, 0, 0x7e, 0, 0xf7]);\n  };\n  MIDI.prototype.match = function(a) {\n    var i, m;\n    for (i = 0; i < a.length; i++) {\n      m = a[i][1];\n      if (typeof m == 'undefined') {\n        if (this[i] != a[i]) return false;\n      }\n      else {\n        if ((this[i] & m) != (a[i][0] & m)) return false;\n      }\n    }\n    return true;\n  };\n\n  function _s2a(x) {\n    var a = [];\n    for (var i = 0; i < x.length; i++) {\n      a[i] = x.charCodeAt(i);\n    }\n    return a;\n  }\n  function _a2s(x) {\n    var a = '';\n    for (var i = 0; i < x.length; i++) {\n      a += String.fromCharCode(x[i]);\n    }\n    return a;\n  }\n  function _2s(x) {\n    return x instanceof Array ? _a2s(x) : typeof x == 'undefined' ? '' : '' + x;\n  }\n  function _s2n(x) {\n    var n = 0;\n    for (var i = 0; i < x.length; i++) n = (n << 8) + x.charCodeAt(i);\n    return n;\n  }\n\n  function __hex(x) { return (x < 16 ? '0' : '') + x.toString(16); }\n  function _hex(x) {\n    var a = [];\n    for (var i = 0; i < x.length; i++) {\n      a[i] = __hex(x[i]);\n    }\n    return a.join(' ');\n  }\n  function _toLine(s) {\n    var out = '';\n    for (var i = 0; i < s.length; i++) {\n      if (s[i] == '\\n') out += '\\\\n';\n      else if (s[i] == '\\r') out += '\\\\r';\n      else if (s[i] == '\\t') out += '\\\\t';\n      else if (s.charCodeAt(i) < 32) out += '\\\\x' + __hex(s.charCodeAt(i));\n      else out += s[i];\n    }\n    return out;\n  }\n  function _smfhex(dd) {\n    return dd.length ? ': ' + _hex(_s2a(dd)) : '';\n  }\n  function _smftxt(dd) {\n    return dd.length ? ': ' + _toLine(JZZ.lib.fromUTF8(dd)) : '';\n  }\n  MIDI.prototype.label = function(s) {\n    this.lbl = this.lbl ? this.lbl + ', ' + s : s;\n    return this;\n  };\n  MIDI.prototype.toString = function() {\n    return this.lbl ? this._str() + ' (' + this.lbl + ')' : this._str();\n  };\n  MIDI.prototype._str = function() {\n    var s;\n    var ss;\n    if (!this.length) {\n      if (typeof this.ff != 'undefined') {\n        s = 'ff' + __hex(this.ff) + ' -- ';\n        if (this.ff == 0) s += 'Sequence Number: ' + _s2n(this.dd);\n        else if (this.ff > 0 && this.ff < 10) s += ['', 'Text', 'Copyright', 'Sequence Name', 'Instrument Name', 'Lyric', 'Marker', 'Cue Point', 'Program Name', 'Device Name'][this.ff] + _smftxt(this.dd);\n        else if (this.ff == 32) s += 'Channel Prefix' + _smfhex(this.dd);\n        else if (this.ff == 33) s += 'MIDI Port' + _smfhex(this.dd);\n        else if (this.ff == 47) s += 'End of Track' + _smfhex(this.dd);\n        else if (this.ff == 81) {\n          var bpm = Math.round(this.getBPM() * 100) / 100;\n          s += 'Tempo: ' + bpm + ' bpm';\n        }\n        else if (this.ff == 84) s += 'SMPTE Offset: ' + _smptetxt(_s2a(this.dd));\n        else if (this.ff == 88) {\n          var d = 1 << this.dd.charCodeAt(1);\n          s += 'Time Signature: ' + this.dd.charCodeAt(0) + '/' + d;\n          s += ' ' + this.dd.charCodeAt(2) + ' ' + this.dd.charCodeAt(3);\n        }\n        else if (this.ff == 89) {\n          s += 'Key Signature: ';\n          var ks = this.getKeySignature();\n          if (ks) {\n            s += ks[1];\n            if (ks[2]) s += ' min';\n          }\n          else s+= 'invalid';\n        }\n        else if (this.ff == 127) {\n          if (this.dd.charCodeAt(0) == 0x43) {\n            if (this.dd.charCodeAt(1) == 0x7b) {\n              s += '[XF:' + __hex(this.dd.charCodeAt(2)) + ']';\n              ss = { 0: 'Version', 1: 'Chord', 2: 'Rehearsal Mark', 3: 'Phrase Mark', 4: 'Max Phrase Mark',\n                5: 'Fingering Number', 12: 'Guide Track Flag', 16: 'Guitar Info', 18: 'Chord Voicing',\n                127: 'XG Song Data Number' }[this.dd.charCodeAt(2)];\n              s += ss ? ' ' + ss : '';\n              s += ': ';\n              if (this.dd.charCodeAt(2) == 0) {\n                return s + this.dd.substr(3, 4) + ' ' + _hex(_s2a(this.dd.substr(7)));\n              }\n              if (this.dd.charCodeAt(2) == 1) {\n                return s + this.getText();\n              }\n              return s + _hex(_s2a(this.dd.substr(3)));\n            }\n          }\n          s += 'Sequencer Specific' + _smfhex(this.dd);\n        }\n        else s += 'SMF' + _smfhex(this.dd);\n        return s;\n      }\n      return 'empty';\n    }\n    s = _hex(this);\n    if (this[0] < 0x80) return s;\n    ss = {\n      241: 'MIDI Time Code',\n      242: 'Song Position',\n      243: 'Song Select',\n      244: 'Undefined',\n      245: 'Undefined',\n      246: 'Tune request',\n      248: 'Timing clock',\n      249: 'Undefined',\n      250: 'Start',\n      251: 'Continue',\n      252: 'Stop',\n      253: 'Undefined',\n      254: 'Active Sensing',\n      255: 'Reset'\n    }[this[0]];\n    if (ss) return s + ' -- ' + ss;\n    if (this.isMidiSoft()) {\n      ss = _toLine(this.getText());\n      if (ss) ss = ' ' + ss;\n      return s + ' -- [K:' + __hex(this[5]) + ']' + ss;\n    }\n    var c = this[0] >> 4;\n    ss = {8: 'Note Off', 10: 'Aftertouch', 12: 'Program Change', 13: 'Channel Aftertouch', 14: 'Pitch Wheel'}[c];\n    if (ss) return s + ' -- ' + ss;\n    if (c == 9) return s + ' -- ' + (this[2] ? 'Note On' : 'Note Off');\n    if (c != 11) return s;\n    ss = {\n      0: 'Bank Select MSB',\n      1: 'Modulation Wheel MSB',\n      2: 'Breath Controller MSB',\n      4: 'Foot Controller MSB',\n      5: 'Portamento Time MSB',\n      6: 'Data Entry MSB',\n      7: 'Channel Volume MSB',\n      8: 'Balance MSB',\n      10: 'Pan MSB',\n      11: 'Expression Controller MSB',\n      12: 'Effect Control 1 MSB',\n      13: 'Effect Control 2 MSB',\n      16: 'General Purpose Controller 1 MSB',\n      17: 'General Purpose Controller 2 MSB',\n      18: 'General Purpose Controller 3 MSB',\n      19: 'General Purpose Controller 4 MSB',\n      31: 'Karaoke',\n      32: 'Bank Select LSB',\n      33: 'Modulation Wheel LSB',\n      34: 'Breath Controller LSB',\n      36: 'Foot Controller LSB',\n      37: 'Portamento Time LSB',\n      38: 'Data Entry LSB',\n      39: 'Channel Volume LSB',\n      40: 'Balance LSB',\n      42: 'Pan LSB',\n      43: 'Expression Controller LSB',\n      44: 'Effect control 1 LSB',\n      45: 'Effect control 2 LSB',\n      48: 'General Purpose Controller 1 LSB',\n      49: 'General Purpose Controller 2 LSB',\n      50: 'General Purpose Controller 3 LSB',\n      51: 'General Purpose Controller 4 LSB',\n      64: 'Damper Pedal',\n      65: 'Portamento',\n      66: 'Sostenuto',\n      67: 'Soft Pedal',\n      68: 'Legato',\n      69: 'Hold 2',\n      70: 'Sound Variation',\n      71: 'Filter Resonance',\n      72: 'Release Time',\n      73: 'Attack Time',\n      74: 'Brightness',\n      75: 'Decay Time',\n      76: 'Vibrato Rate',\n      77: 'Vibrato Depth',\n      78: 'Vibrato Delay',\n      79: 'Sound Controller 10',\n      80: 'General Purpose Controller 5',\n      81: 'General Purpose Controller 6',\n      82: 'General Purpose Controller 7',\n      83: 'General Purpose Controller 8',\n      84: 'Portamento Control',\n      88: 'High Resolution Velocity Prefix',\n      91: 'Effects 1 Depth',\n      92: 'Effects 2 Depth',\n      93: 'Effects 3 Depth',\n      94: 'Effects 4 Depth',\n      95: 'Effects 5 Depth',\n      96: 'Data Increment',\n      97: 'Data Decrement',\n      98: 'Non-Registered Parameter Number LSB',\n      99: 'Non-Registered Parameter Number MSB',\n      100: 'Registered Parameter Number LSB',\n      101: 'Registered Parameter Number MSB',\n      120: 'All Sound Off',\n      121: 'Reset All Controllers',\n      122: 'Local Control On/Off',\n      123: 'All Notes Off',\n      124: 'Omni Mode Off',\n      125: 'Omni Mode On',\n      126: 'Mono Mode On',\n      127: 'Poly Mode On'\n    }[this[1]];\n    if (this[1] >= 64 && this[1] <= 69) ss += this[2] < 64 ? ' Off' : ' On';\n    if (!ss) ss = 'Undefined';\n    return s + ' -- ' + ss;\n  };\n  MIDI.prototype._stamp = function(obj) { this._from.push(obj._orig ? obj._orig : obj); return this; };\n  MIDI.prototype._unstamp = function(obj) {\n    if (typeof obj == 'undefined') this._from = [];\n    else {\n      if (obj._orig) obj = obj._orig;\n      var i = this._from.indexOf(obj);\n      if (i > -1) this._from.splice(i, 1);\n    }\n    return this;\n  };\n  MIDI.prototype._stamped = function(obj) {\n    if (obj._orig) obj = obj._orig;\n    for (var i = 0; i < this._from.length; i++) if (this._from[i] == obj) return true;\n    return false;\n  };\n\n  JZZ.MIDI = MIDI;\n  _J.prototype.MIDI = MIDI;\n\n  function _clear_ctxt() {\n    var i;\n    this._cc = [];\n    for (i = 0; i < 16; i++) this._cc[i] = {};\n  }\n  function _rpn_txt(msb, lsb) {\n    var a = typeof msb == 'undefined' ? '??' : __hex(msb);\n    var b = typeof lsb == 'undefined' ? '??' : __hex(lsb);\n    var c = {\n      '0000': 'Pitch Bend Sensitivity',\n      '0001': 'Channel Fine Tune',\n      '0002': 'Channel Coarse Tune',\n      '0003': 'Select Tuning Program',\n      '0004': 'Select Tuning Bank',\n      '0005': 'Vibrato Depth Range',\n      '7f7f': 'NONE'\n    }[a + '' + b];\n    return 'RPN ' + a + ' ' + b + (c ? ': ' + c : '');\n  }\n  function _nrpn_txt(msb, lsb) {\n    var a = typeof msb == 'undefined' ? '??' : __hex(msb);\n    var b = typeof lsb == 'undefined' ? '??' : __hex(lsb);\n    return 'NRPN ' + a + ' ' + b;\n  }\n  function _read_ctxt(msg) {\n    if (!msg.length || msg[0] < 0x80) return msg;\n    if (msg[0] == 0xff) { this._clear(); return msg; }\n    var ch = msg[0] & 15;\n    var st = msg[0] >> 4;\n    var s;\n    if (st == 12) {\n      msg._bm = this._cc[ch].bm;\n      msg._bl = this._cc[ch].bl;\n      if (JZZ.MIDI.programName) msg.label(JZZ.MIDI.programName(msg[1], msg._bm, msg._bl));\n    }\n    else if (st == 11) {\n      switch (msg[1]) {\n        case 0: this._cc[ch].bm = msg[2]; break;\n        case 32: this._cc[ch].bl = msg[2]; break;\n        case 98: this._cc[ch].nl = msg[2]; this._cc[ch].rn = 'n'; break;\n        case 99: this._cc[ch].nm = msg[2]; this._cc[ch].rn = 'n'; break;\n        case 100: this._cc[ch].rl = msg[2]; this._cc[ch].rn = 'r'; break;\n        case 101: this._cc[ch].rm = msg[2]; this._cc[ch].rn = 'r'; break;\n        case 6: case 38: case 96: case 97:\n          if (this._cc[ch].rn == 'r') {\n            msg._rm = this._cc[ch].rm;\n            msg._rl = this._cc[ch].rl;\n            msg.label(_rpn_txt(this._cc[ch].rm, this._cc[ch].rl));\n          }\n          if (this._cc[ch].rn == 'n') {\n            msg._nm = this._cc[ch].rm;\n            msg._nl = this._cc[ch].nl;\n            msg.label(_nrpn_txt(this._cc[ch].nm, this._cc[ch].nl));\n          }\n          break;\n      }\n    }\n    else if (msg.isFullSysEx()) {\n      if (msg[1] == 0x7f) {\n        if (msg[3] == 4) {\n          s = { 1: 'Master Volume', 2: 'Master Balance', 3: 'Master Fine Tuning', 4: 'Master Coarse Tuning' }[msg[4]];\n          if (s) msg.label(s);\n        }\n        else if (msg[3] == 8) {\n          s = { 2: 'Note Tuning', 7: 'Note Tuning, Bank', 8: 'Scale Tuning, 1 byte format', 9: 'Scale Tuning, 2 byte format' }[msg[4]];\n          if (s) msg.label(s);\n        }\n      }\n      else if (msg[1] == 0x7e) {\n        if (msg[3] == 6) {\n          if (msg[4] == 1) msg.label('Device ID Request');\n          else if (msg[4] == 2) {\n            msg.label('Device ID Response');\n          }\n        }\n        else if (msg[3] == 8) {\n          s = {\n            0: 'Bulk Tuning Dump Request', 1: 'Bulk Tuning Dump', 3: 'Bulk Tuning Dump Request, Bank', 4: 'Bulk Tuning Dump, Bank',\n            5: 'Scale Tuning Dump, 1 byte format', 6: 'Scale Tuning Dump, 2 byte format',\n            7: 'Note Tuning, Bank', 8: 'Scale Tuning, 1 byte format', 9: 'Scale Tuning, 2 byte format'\n          }[msg[4]];\n          if (s) msg.label(s);\n        }\n        else if (msg[3] == 9) {\n          if (msg[4] == 1) { msg.label('GM1 System On'); this._clear(); this._gm = '1'; }\n          else if (msg[4] == 2) { msg.label('GM System Off'); this._clear(); this._gm = '0'; }\n          else if (msg[4] == 3) { msg.label('GM2 System On'); this._clear(); this._gm = '2'; }\n        }\n      }\n      else if (msg[1] == 0x43) {\n        if ((msg[2] & 0xf0) == 0x10 && msg[3] == 0x4c) {\n          if (msg[4] == 0 && msg[5] == 0 && msg[6] == 0x7e && msg[7] == 0) {\n            msg.label('XG System On'); this._clear(); this._gm = 'Y';\n          }\n          else if (msg[4] == 0 && msg[5] == 0 && msg[6] == 0) msg.label('XG Master Tuning');\n          else if (msg[4] == 0 && msg[5] == 0 && msg[6] == 4) msg.label('XG Master Volume');\n          else if (msg[4] == 0 && msg[5] == 0 && msg[6] == 6) msg.label('XG Master Transpose');\n          else if (msg[4] == 8 && msg[5] < 16 && msg[6] >= 0x41 && msg[6] <= 0x4c) msg.label('XG Scale Tuning');\n          else  msg.label('XG Parameter');\n        }\n      }\n      else if (msg[1] == 0x41) {\n        if (msg[3] == 0x42 && msg[4] == 0x12) {\n          if (msg[5] == 0x40) {\n            if (msg[6] == 0) {\n              if (msg[7] == 0x7f && msg[8] == 0 && msg[9] == 0x41) {\n                msg.label('GS Reset'); this._clear(); this._gm = 'R';\n              }\n              else if (msg[7] == 0) msg.label('GS Master Tuning');\n              else if (msg[7] == 4) msg.label('GS Master Volume');\n              else if (msg[7] == 5) msg.label('GS Master Transpose');\n              else msg.label('GS Parameter');\n            }\n            else if ((msg[6] & 0xf0) == 0x10 && msg[7] == 0x15) msg.label('GS Drum Part Change');\n            else if ((msg[6] & 0xf0) == 0x10 && msg[7] >= 0x40 && msg[7] <= 0x4b) msg.label('GS Scale Tuning');\n            else msg.label('GS Parameter');\n          }\n          if (msg[5] == 0x41) msg.label('GS Parameter');\n        }\n      }\n    }\n    return msg;\n  }\n  function Context() {\n    var self = new _M();\n    self._clear = _clear_ctxt;\n    self._read = _read_ctxt;\n    self._receive = function(msg) { this._emit(this._read(msg)); };\n    self._clear();\n    self._resume();\n    return self;\n  }\n  JZZ.Context = Context;\n  _J.prototype.Context = Context;\n\n  function MPE() {\n    var self = this instanceof MPE ? this : self = new MPE();\n    self.reset();\n    if (arguments.length) MPE.prototype.setup.apply(self, arguments);\n    return self;\n  }\n  MPE.validate = function(arg) {\n    var a = arg instanceof Array ? arg : arguments;\n    if (a[0] != parseInt(a[0]) || a[0] < 0 || a[0] > 14) throw RangeError('Bad master channel value: ' + a[0]);\n    if (a[1] != parseInt(a[1]) || a[1] < 0 || a[0] + a[1] > 15) throw RangeError('Bad zone size value: ' + a[1]);\n  };\n  MPE.prototype.reset = function() { for (var n = 0; n < 16; n++) this[n] = { band: 0, master: n }; };\n  MPE.prototype.setup = function(m, n) {\n    MPE.validate(m, n);\n    var k;\n    var last = m + n;\n    if (this[m].master == m && this[m].band == n) return;\n    if (!n && !this[m].band) return;\n    if (this[m].band) {\n      k = m + this[m].band;\n      if (last < k) last = k;\n    }\n    else if (this[m].master == m - 1) {\n      k = m - 1;\n      k = k + this[k].band;\n      if (last < k) last = k;\n      this[m - 1] = { band: 0, master: m - 1 };\n    }\n    else if (this[m].master != m) {\n      k = this[m].master;\n      k = k + this[k].band;\n      if (last < k) last = k;\n      this[this[m].master].band = m - this[m].master - 1;\n    }\n    this[m].master = m;\n    this[m].band = n;\n    for (k = m + 1; k <= m + n; k++) {\n      if (this[k].band && last < k + this[k].band) last = k + this[k].band;\n      this[k] = { band: 0, master: m };\n    }\n    for (; k <= last; k++) this[k] = { band: 0, master: k };\n  };\n  MPE.prototype.filter = function(msg) {\n    var c = msg.getChannel();\n    if (!this[c] || !this[this[c].master].band) return msg;\n    var m = this[c].master;\n    var n = this[m].band;\n    var i, j, k;\n    if (typeof msg._mpe != 'undefined') {\n      k = 256;\n      for (i = m + 1; i <= m + n; i++) {\n        if (!this[i].notes) {\n          if (k > 0) { c = i; k = 0; }\n        }\n        else {\n          if (k > this[i].notes.length) { c = i; k = this[i].notes.length; }\n          for (j = 0; j < this[i].notes.length; j++) {\n            if (this[i].notes[j] == msg._mpe) { c = i; k = -1; break; }\n          }\n        }\n      }\n      msg.setChannel(c);\n      msg._mpe = undefined;\n    }\n    if (c == m) return msg; // bad mpe\n    if (msg.isNoteOn()) {\n      if (!this[c].notes) this[c].notes = [];\n      _push(this[c].notes, msg.getNote());\n    }\n    else if (msg.isNoteOff()) {\n      if (this[c].notes) _pop(this[c].notes, msg.getNote());\n    }\n    return msg;\n  };\n  JZZ.MPE = MPE;\n\n  JZZ.lib = {};\n  JZZ.lib.now = _now;\n  JZZ.lib.schedule = _schedule;\n  var _sch_list = [];\n  var _sch_worker;\n  var _sch_count = 0;\n  try {\n    var _blob = URL.createObjectURL(new Blob(['(', function() {\n      function tick() {\n        postMessage({});\n        setTimeout(tick, 0);\n      }\n      tick();\n    }.toString(), ')()'], { type: 'application/javascript' }));\n    var _sch_tick = function() {\n      var n = _sch_list.length;\n      // cannot use i < _sch_list.length !\n      for (var i = 0; i < n; i++) _sch_list.shift()();\n      _sch_count++;\n      if (_sch_count > 20 && _sch_worker) {\n        _sch_worker.terminate();\n        _sch_worker = undefined;\n      }\n    };\n    var _sch = function(x) {\n      _sch_list.push(x);\n      _sch_count = 0;\n      if (!_sch_worker) {\n        _sch_worker = new Worker(_blob);\n        _sch_worker.onmessage = _sch_tick;\n      }\n    };\n    _sch(function() { JZZ.lib.schedule = _sch; });\n  }\n  catch (e) {}\n\n  JZZ.lib.openMidiOut = function(name, engine) {\n    var port = new _M();\n    engine._openOut(port);\n    port._info = engine._info(name);\n    return port;\n  };\n  JZZ.lib.openMidiIn = function(name, engine) {\n    var port = new _M();\n    engine._openIn(port);\n    port._info = engine._info(name);\n    return port;\n  };\n  JZZ.lib.registerMidiOut = function(name, engine) {\n    var x = engine._info(name);\n    for (var i = 0; i < _virtual._outs.length; i++) if (_virtual._outs[i].name == x.name) return false;\n    x.engine = engine;\n    _virtual._outs.push(x);\n    if (_jzz) {\n      _postRefresh();\n      if (_jzz._bad) { _jzz._repair(); _jzz._resume(); }\n    }\n    return true;\n  };\n  JZZ.lib.registerMidiIn = function(name, engine) {\n    var x = engine._info(name);\n    for (var i = 0; i < _virtual._ins.length; i++) if (_virtual._ins[i].name == x.name) return false;\n    x.engine = engine;\n    _virtual._ins.push(x);\n    if (_jzz) {\n      _postRefresh();\n      if (_jzz._bad) { _jzz._repair(); _jzz._resume(); }\n    }\n    return true;\n  };\n  var _ac;\n  function _initAudioContext() {\n    if (!_ac && typeof window !== 'undefined') {\n      var AudioContext = window.AudioContext || window.webkitAudioContext;\n      if (AudioContext) {\n        _ac = new AudioContext();\n        if (_ac && !_ac.createGain) _ac.createGain = _ac.createGainNode;\n        var _activateAudioContext = function() {\n          if (_ac.state != 'running') {\n            _ac.resume();\n            var osc = _ac.createOscillator();\n            var gain = _ac.createGain();\n            try { gain.gain.value = 0; } catch (err) {}\n            gain.gain.setTargetAtTime(0, _ac.currentTime, 0.01);\n            osc.connect(gain);\n            gain.connect(_ac.destination);\n            if (!osc.start) osc.start = osc.noteOn;\n            if (!osc.stop) osc.stop = osc.noteOff;\n            osc.start(0.1); osc.stop(0.11);\n          }\n          else if (typeof document != 'undefined') {\n            document.removeEventListener('touchstart', _activateAudioContext);\n            document.removeEventListener('touchend', _activateAudioContext);\n            document.removeEventListener('mousedown', _activateAudioContext);\n            document.removeEventListener('keydown', _activateAudioContext);\n          }\n        };\n        if (typeof document != 'undefined') {\n          document.addEventListener('touchstart', _activateAudioContext);\n          document.addEventListener('touchend', _activateAudioContext);\n          document.addEventListener('mousedown', _activateAudioContext);\n          document.addEventListener('keydown', _activateAudioContext);\n        }\n        _activateAudioContext();\n      }\n    }\n  }\n  JZZ.lib.copyMidiHelpers = _copyMidiHelpers;\n  JZZ.lib.getAudioContext = function() { _initAudioContext(); return _ac; };\n  var _b64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\n  JZZ.lib.fromBase64 = function(input) {\n    var output = '';\n    var chr1, chr2, chr3;\n    var enc1, enc2, enc3, enc4;\n    var i = 0;\n    input = input.replace(/[^A-Za-z0-9+/=]/g, '');\n    while (i < input.length) {\n      enc1 = _b64.indexOf(input.charAt(i++));\n      enc2 = _b64.indexOf(input.charAt(i++));\n      enc3 = _b64.indexOf(input.charAt(i++));\n      enc4 = _b64.indexOf(input.charAt(i++));\n      chr1 = (enc1 << 2) | (enc2 >> 4);\n      chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);\n      chr3 = ((enc3 & 3) << 6) | enc4;\n      output = output + String.fromCharCode(chr1);\n      if (enc3 != 64) {\n        output = output + String.fromCharCode(chr2);\n      }\n      if (enc4 != 64) {\n        output = output + String.fromCharCode(chr3);\n      }\n    }\n    return output;\n  };\n  JZZ.lib.toBase64 = function(data) {\n    var o1, o2, o3, h1, h2, h3, h4, bits, i = 0, ac = 0, enc = '', arr = [];\n    if (!data) return data;\n    do {\n      o1 = data.charCodeAt(i++);\n      o2 = data.charCodeAt(i++);\n      o3 = data.charCodeAt(i++);\n      bits = o1 << 16 | o2 << 8 | o3;\n      h1 = bits >> 18 & 0x3f;\n      h2 = bits >> 12 & 0x3f;\n      h3 = bits >> 6 & 0x3f;\n      h4 = bits & 0x3f;\n      arr[ac++] = _b64.charAt(h1) + _b64.charAt(h2) + _b64.charAt(h3) + _b64.charAt(h4);\n    } while(i < data.length);\n    enc = arr.join('');\n    var r = data.length % 3;\n    return (r ? enc.slice(0, r - 3) + '==='.slice(r) : enc);\n  };\n  JZZ.lib.fromUTF8 = function(data) {\n    data = typeof data == 'undefined' ? '' : '' + data;\n    var out = '';\n    var i, n, m;\n    for (i = 0; i < data.length; i++) {\n      n = data.charCodeAt(i);\n      if (n > 0xff) return data;\n      if (n < 0x80) out += data[i];\n      else if ((n & 0xe0) == 0xc0) {\n        n = (n & 0x1f) << 6;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f);\n        out += String.fromCharCode(n);\n      }\n      else if ((n & 0xf0) == 0xe0) {\n        n = (n & 0x0f) << 12;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f) << 6;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f);\n        out += String.fromCharCode(n);\n      }\n      else if ((n & 0xf8) == 0xf0) {\n        n = (n & 0x07) << 18;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f) << 12;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f) << 6;\n        i++; if (i >= data.length) return data;\n        m = data.charCodeAt(i);\n        if ((m & 0xc0) != 0x80) return data;\n        n += (m & 0x3f);\n        if (n > 0x10ffff) return data;\n        n -= 0x10000;\n        out += String.fromCharCode(0xd800 + (n >> 10));\n        out += String.fromCharCode(0xdc00 + (n & 0x3ff));\n      }\n    }\n    return out;\n  };\n  JZZ.lib.toUTF8 = function(data) {\n    data = typeof data == 'undefined' ? '' : '' + data;\n    var out = '';\n    var i, n;\n    for (i = 0; i < data.length; i++) {\n      n = data.charCodeAt(i);\n      if (n < 0x80) out += data[i];\n      else if (n < 0x800) {\n        out += String.fromCharCode(0xc0 + (n >> 6));\n        out += String.fromCharCode(0x80 + (n & 0x3f));\n      }\n      else if (n < 0x10000) {\n        out += String.fromCharCode(0xe0 + (n >> 12));\n        out += String.fromCharCode(0x80 + ((n >> 6) & 0x3f));\n        out += String.fromCharCode(0x80 + (n & 0x3f));\n      }\n      /* istanbul ignore next */\n      else {\n        out += String.fromCharCode(0xf0 + (n >> 18));\n        out += String.fromCharCode(0x80 + ((n >> 12) & 0x3f));\n        out += String.fromCharCode(0x80 + ((n >> 6) & 0x3f));\n        out += String.fromCharCode(0x80 + (n & 0x3f));\n      }\n    }\n    return out;\n  };\n\n  // Web MIDI API\n  var _wma = [];\n  var _outputMap = {};\n  var _inputMap = {};\n\n  var Promise = _scope.Promise;\n  /* istanbul ignore next */\n  if (typeof Promise !== 'function') {\n    Promise = function(executor) {\n      this.executor = executor;\n    };\n    Promise.prototype.then = function(resolve, reject) {\n      if (typeof resolve !== 'function') {\n        resolve = _nop;\n      }\n      if (typeof reject !== 'function') {\n        reject = _nop;\n      }\n      this.executor(resolve, reject);\n    };\n  }\n  function DOMException(name, message, code) {\n    this.name = name;\n    this.message = message;\n    this.code = code;\n  }\n\n  function MIDIConnectionEvent(port, target) {\n    this.bubbles = false;\n    this.cancelBubble = false;\n    this.cancelable = false;\n    this.currentTarget = target;\n    this.defaultPrevented = false;\n    this.eventPhase = 0;\n    this.path = [];\n    this.port = port;\n    this.returnValue = true;\n    this.srcElement = target;\n    this.target = target;\n    this.timeStamp = _now();\n    this.type = 'statechange';\n  }\n\n  function MIDIMessageEvent(port, data) {\n    this.bubbles = false;\n    this.cancelBubble = false;\n    this.cancelable = false;\n    this.currentTarget = port;\n    this.data = data;\n    this.defaultPrevented = false;\n    this.eventPhase = 0;\n    this.path = [];\n    this.receivedTime = _now();\n    this.returnValue = true;\n    this.srcElement = port;\n    this.target = port;\n    this.timeStamp = this.receivedTime;\n    this.type = 'midimessage';\n  }\n\n  function _statechange(p, a) {\n    if (p) {\n      if (p.onstatechange) p.onstatechange(new MIDIConnectionEvent(p, p));\n      if (a.onstatechange) a.onstatechange(new MIDIConnectionEvent(p, a));\n    }\n  }\n\n  function MIDIInput(a, p) {\n    var self = this;\n    var _open = false;\n    var _ochng = null;\n    var _onmsg = null;\n    this.type = 'input';\n    this.id = p.id;\n    this.name = p.name;\n    this.manufacturer = p.man;\n    this.version = p.ver;\n    Object.defineProperty(this, 'state', { get: function() { return p.connected ? 'connected' : 'disconnected'; }, enumerable: true });\n    Object.defineProperty(this, 'connection', { get: function() {\n      return _open ? p.proxy ? 'open' : 'pending' : 'closed';\n    }, enumerable: true });\n    Object.defineProperty(this, 'onmidimessage', {\n      get: function() { return _onmsg; },\n      set: function(value) {\n        if (_func(value)) {\n          _onmsg = value;\n          if (!_open) self.open().then(_nop, _nop);\n        }\n        else _onmsg = null;\n      },\n      enumerable: true\n    });\n    Object.defineProperty(this, 'onstatechange', {\n      get: function() { return _ochng; },\n      set: function(value) {\n        if (_func(value)) _ochng = value;\n        else _ochng = null;\n      },\n      enumerable: true\n    });\n    this.open = function() {\n      return new Promise(function(resolve, reject) {\n        if (_open) resolve(self);\n        else {\n          p.open().then(function() {\n            if (!_open) {\n              _open = true;\n              _statechange(self, a);\n            }\n            resolve(self);\n          }, function() {\n            reject(new DOMException('InvalidAccessError', 'Port is not available', 15));\n          });\n        }\n      });\n    };\n    this.close = function() {\n      return new Promise(function(resolve/*, reject*/) {\n        if (_open) {\n          _open = false;\n          p.close();\n          _statechange(self, a);\n        }\n        resolve(self);\n      });\n    };\n    Object.freeze(this);\n  }\n\n  function _split(q) {\n    var i, k;\n    while (q.length) {\n      for (i = 0; i < q.length; i++) if (q[i] == parseInt(q[i]) && q[i] >= 0x80 && q[i] <= 0xff && q[i] != 0xf7) break;\n      q.splice(0, i);\n      if (!q.length) return;\n      if (q[0] == 0xf0) {\n        for (i = 1; i < q.length; i++) if (q[i] == 0xf7) break;\n        if (i == q.length) return;\n        return q.splice(0, i + 1);\n      }\n      else {\n        k = _datalen(q[0]) + 1;\n        if (k > q.length) return;\n        for (i = 1; i < k; i++) if (q[i] != parseInt(q[i]) || q[i] < 0 || q[i] >= 0x80) break;\n        if (i == k) return q.splice(0, i);\n        else q.splice(0, i);\n      }\n    }\n  }\n\n  function _InputProxy(id, name, man, ver) {\n    var self = this;\n    this.id = id;\n    this.name = name;\n    this.man = man;\n    this.ver = ver;\n    this.connected = true;\n    this.ports = [];\n    this.pending = [];\n    this.proxy = undefined;\n    this.queue = [];\n    this.onmidi = function(msg) {\n      var m;\n      self.queue = self.queue.concat(msg.slice());\n      for (m = _split(self.queue); m; m = _split(self.queue)) {\n        for (i = 0; i < self.ports.length; i++) {\n          if (self.ports[i][0].onmidimessage && (m[0] != 0xf0 || self.ports[i][1])) {\n            self.ports[i][0].onmidimessage(new MIDIMessageEvent(self, new Uint8Array(m)));\n          }\n        }\n      }\n    };\n  }\n  _InputProxy.prototype.open = function() {\n    var self = this;\n    return new Promise(function(resolve, reject) {\n      var i;\n      if (self.proxy || !self.connected) resolve();\n      else {\n        self.pending.push([resolve, reject]);\n        if (self.pending.length == 1) {\n          JZZ().openMidiIn(self.name).or(function() {\n            for (i = 0; i < self.pending.length; i++) self.pending[i][1]();\n            self.pending = [];\n          }).and(function() {\n            self.proxy = this;\n            self.proxy.connect(self.onmidi);\n            for (i = 0; i < self.pending.length; i++) self.pending[i][0]();\n            self.pending = [];\n          });\n        }\n      }\n    });\n  };\n  _InputProxy.prototype.close = function() {\n    var i;\n    if (this.proxy) {\n      for (i = 0; i < this.ports.length; i++) if (this.ports[i].connection == 'open') return;\n      this.proxy.close();\n      this.proxy = undefined;\n    }\n  };\n  _InputProxy.prototype.disconnect = function() {\n    this.connected = false;\n    if (this.proxy) {\n      this.proxy.close();\n      this.proxy = undefined;\n    }\n  };\n  _InputProxy.prototype.reconnect = function() {\n    var self = this;\n    var i, p;\n    var a = [];\n    this.connected = true;\n    for (i = 0; i < _wma.length; i++) {\n      p = _wma[i].inputs.get(this.id);\n      if (p.connection == 'closed') _statechange(p, _wma[i]);\n      else a.push([p, _wma[i]]);\n    }\n    if (a.length) {\n      JZZ()._openMidiInNR(self.name).or(function() {\n        for (i = 0; i < a.length; i++) a[i][0].close();\n      }).and(function() {\n        self.proxy = this;\n        self.proxy.connect(self.onmidi);\n        for (i = 0; i < a.length; i++) _statechange(a[i][0], a[i][1]);\n      });\n    }\n  };\n\n  function _datalen(x) {\n    if (x >= 0x80 && x <= 0xbf || x >= 0xe0 && x <= 0xef || x == 0xf2) return 2;\n    if (x >= 0xc0 && x <= 0xdf || x == 0xf1 || x == 0xf3) return 1;\n    return 0;\n  }\n\n  var _epr = \"Failed to execute 'send' on 'MIDIOutput': \";\n\n  function _validate(arr, sysex) {\n    var i, k;\n    var msg;\n    var data = [];\n    for (i = 0; i < arr.length; i++) {\n      if (arr[i] != parseInt(arr[i]) || arr[i] < 0 || arr[i] > 255) throw TypeError(_epr + arr[i] + ' is not a UInt8 value.');\n    }\n    k = 0;\n    for (i = 0; i < arr.length; i++) {\n      if (!k) {\n        if (arr[i] < 0x80) throw TypeError(_epr + 'Running status is not allowed at index ' + i + ' (' + arr[i] + ').');\n        if (arr[i] == 0xf7) throw TypeError(_epr + 'Unexpected end of system exclusive message at index ' + i + ' (' + arr[i] + ').');\n        msg = [arr[i]];\n        data.push(msg);\n        if (arr[i] == 0xf0) {\n          if (!sysex) throw new DOMException('InvalidAccessError', _epr + 'System exclusive messag is not allowed at index ' + i + ' (' + arr[i] + ').', 15);\n          k = -1;\n          for (; i < arr.length; i++) {\n            msg.push(arr[i]);\n            if (arr[i] == 0xf7) {\n              k = 0;\n              break;\n            }\n          }\n        }\n        else {\n          k = _datalen(arr[i]);\n        }\n      }\n      else {\n        if (arr[i] > 0x7f) throw TypeError(_epr + 'Unexpected status byte at index ' + i + ' (' + arr[i] + ').');\n        msg.push(arr[i]);\n        k--;\n      }\n    }\n    if (k) throw TypeError(_epr + 'Message is incomplete');\n    return [data];\n  }\n\n  function MIDIOutput(a, p) {\n    var self = this;\n    var _open = false;\n    var _ochng = null;\n    this.type = 'output';\n    this.id = p.id;\n    this.name = p.name;\n    this.manufacturer = p.man;\n    this.version = p.ver;\n    Object.defineProperty(this, 'state', { get: function() { return p.connected ? 'connected' : 'disconnected'; }, enumerable: true });\n    Object.defineProperty(this, 'connection', { get: function() {\n      return _open ? p.proxy ? 'open' : 'pending' : 'closed';\n    }, enumerable: true });\n    Object.defineProperty(this, 'onstatechange', {\n      get: function() { return _ochng; },\n      set: function(value) {\n        if (_func(value)) _ochng = value;\n        else _ochng = null;\n      },\n      enumerable: true\n    });\n    this.open = function() {\n      return new Promise(function(resolve, reject) {\n        if (_open) resolve(self);\n        else {\n          p.open().then(function() {\n            if (!_open) {\n              _open = true;\n              _statechange(self, a);\n            }\n            resolve(self);\n          }, function() {\n            reject(new DOMException('InvalidAccessError', 'Port is not available', 15));\n          });\n        }\n      });\n    };\n    this.close = function() {\n      return new Promise(function(resolve/*, reject*/) {\n        if (_open) {\n          _open = false;\n          self.clear();\n          p.close();\n          _statechange(self, a);\n        }\n        resolve(self);\n      });\n    };\n    this.clear = function() {\n    };\n    this.send = function(data, timestamp) {\n      _validate(data, a.sysexEnabled);\n      if (!p.connected) throw new DOMException('InvalidStateError', 'Port is not connected', 11);\n      if (_open) {\n        var now = _now();\n        if (timestamp > now) setTimeout(function() { p.proxy.send(data); }, timestamp - now);\n        else p.proxy.send(data);\n      }\n      else this.open().then(function() { self.send(data, timestamp); }, _nop);\n    };\n    Object.freeze(this);\n  }\n\n  function _OutputProxy(id, name, man, ver) {\n    this.id = id;\n    this.name = name;\n    this.man = man;\n    this.ver = ver;\n    this.connected = true;\n    this.ports = [];\n    this.pending = [];\n    this.proxy = undefined;\n  }\n  _OutputProxy.prototype.open = function() {\n    var self = this;\n    return new Promise(function(resolve, reject) {\n      var i;\n      if (self.proxy || !self.connected) resolve();\n      else {\n        self.pending.push([resolve, reject]);\n        if (self.pending.length == 1) {\n          JZZ().openMidiOut(self.name).or(function() {\n            for (i = 0; i < self.pending.length; i++) self.pending[i][1]();\n            self.pending = [];\n          }).and(function() {\n            self.proxy = this;\n            for (i = 0; i < self.pending.length; i++) self.pending[i][0]();\n            self.pending = [];\n          });\n        }\n      }\n    });\n  };\n  _OutputProxy.prototype.close = function() {\n    var i;\n    if (this.proxy) {\n      for (i = 0; i < this.ports.length; i++) if (this.ports[i].connection == 'open') return;\n      this.proxy.close();\n      this.proxy = undefined;\n    }\n  };\n  _OutputProxy.prototype.disconnect = function() {\n    this.connected = false;\n    if (this.proxy) {\n      this.proxy.close();\n      this.proxy = undefined;\n    }\n  };\n  _OutputProxy.prototype.reconnect = function() {\n    var self = this;\n    var i, p;\n    var a = [];\n    this.connected = true;\n    for (i = 0; i < _wma.length; i++) {\n      p = _wma[i].outputs.get(this.id);\n      if (p.connection == 'closed') _statechange(p, _wma[i]);\n      else a.push([p, _wma[i]]);\n    }\n    if (a.length) {\n      JZZ()._openMidiOutNR(self.name).or(function() {\n        for (i = 0; i < a.length; i++) a[i][0].close();\n      }).and(function() {\n        self.proxy = this;\n        for (i = 0; i < a.length; i++) _statechange(a[i][0], a[i][1]);\n      });\n    }\n  };\n\n  function _Maplike(data) {\n    this.has = function(id) {\n      return data.hasOwnProperty(id) && data[id].connected;\n    };\n    this.keys = function() {\n      try { // some old browsers may have no Map object\n        var m = new Map();\n        for (var id in data) if (this.has(id)) m.set(id, this.get(id));\n        return m.keys();\n      } catch (e) {}\n    };\n    this.values = function() {\n      try {\n        var m = new Map();\n        for (var id in data) if (this.has(id)) m.set(id, this.get(id));\n        return m.values();\n      } catch (e) {}\n    };\n    this.entries = function() {\n      try {\n        var m = new Map();\n        for (var id in data) if (this.has(id)) m.set(id, this.get(id));\n        return m.entries();\n      } catch (e) {}\n    };\n    this.forEach = function(fun, self) {\n      if (typeof self == 'undefined') self = this;\n      for (var id in data) if (this.has(id)) fun.call(self, this.get(id), id, this);\n    };\n    Object.defineProperty(this, 'size', {\n      get: function() {\n        var len = 0;\n        for (var id in data) if (this.has(id)) len++;\n        return len;\n      },\n      enumerable: true\n    });\n  }\n\n  function MIDIInputMap(_access, _inputs) {\n    this.get = function(id) {\n      if (_inputMap.hasOwnProperty(id) && _inputMap[id].connected) {\n        if (!_inputs[id]) {\n          _inputs[id] = new MIDIInput(_access, _inputMap[id]);\n          _inputMap[id].ports.push([_inputs[id], _access.sysexEnabled]);\n        }\n        return _inputs[id];\n      }\n    };\n    Object.freeze(this);\n  }\n  MIDIInputMap.prototype = new _Maplike(_inputMap);\n  MIDIInputMap.prototype.constructor = MIDIInputMap;\n\n  function MIDIOutputMap(_access, _outputs) {\n    this.get = function(id) {\n      if (_outputMap.hasOwnProperty(id) && _outputMap[id].connected) {\n        if (!_outputs[id]) {\n          _outputs[id] = new MIDIOutput(_access, _outputMap[id]);\n          _outputMap[id].ports.push([_outputs[id], _access.sysexEnabled]);\n        }\n        return _outputs[id];\n      }\n    };\n    Object.freeze(this);\n  }\n  MIDIOutputMap.prototype = new _Maplike(_outputMap);\n  MIDIOutputMap.prototype.constructor = MIDIOutputMap;\n\n  function _wm_watch(x) {\n    var i, k, p, a;\n    for (i = 0; i < x.inputs.added.length; i++) {\n      p = x.inputs.added[i];\n      if (!_inputMap.hasOwnProperty(p.id)) _inputMap[p.id] = new _InputProxy(p.id, p.name, p.manufacturer, p.version);\n      _inputMap[p.id].reconnect();\n    }\n    for (i = 0; i < x.outputs.added.length; i++) {\n      p = x.outputs.added[i];\n      if (!_outputMap.hasOwnProperty(p.id)) _outputMap[p.id] = new _OutputProxy(p.id, p.name, p.manufacturer, p.version);\n      _outputMap[p.id].reconnect();\n    }\n    for (i = 0; i < x.inputs.removed.length; i++) {\n      p = x.inputs.removed[i];\n      if (_inputMap.hasOwnProperty(p.id)) {\n        a = [];\n        for (k = 0; k < _wma.length; k++) a.push([_wma[k].inputs.get(p.id), _wma[k]]);\n        _inputMap[p.id].disconnect();\n        for (k = 0; k < a.length; k++) _statechange(a[k][0], a[k][1]);\n      }\n    }\n    for (i = 0; i < x.outputs.removed.length; i++) {\n      p = x.outputs.removed[i];\n      if (_outputMap.hasOwnProperty(p.id)) {\n        a = [];\n        for (k = 0; k < _wma.length; k++) a.push([_wma[k].outputs.get(p.id), _wma[k]]);\n        _outputMap[p.id].disconnect();\n        for (k = 0; k < a.length; k++) _statechange(a[k][0], a[k][1]);\n      }\n    }\n  }\n\n  function MIDIAccess(sysex) {\n    var _inputs = {};\n    var _outputs = {};\n    var _onstatechange = null;\n    var self = this;\n    this.sysexEnabled = sysex;\n    this.inputs = new MIDIInputMap(self, _inputs);\n    this.outputs = new MIDIOutputMap(self, _outputs);\n    Object.defineProperty(this, 'onstatechange', {\n      get: function() { return _onstatechange; },\n      set: function(f) { _onstatechange = _func(f) ? f : null; },\n      enumerable: true\n    });\n    Object.freeze(this);\n    var i;\n    var p;\n    var info = _jzz._info;\n    for (i = 0; i < info.inputs.length; i++) {\n      p = info.inputs[i];\n      if (!_inputMap.hasOwnProperty(p.id)) _inputMap[p.id] = new _InputProxy(p.id, p.name, p.manufacturer, p.version);\n    }\n    for (i = 0; i < info.outputs.length; i++) {\n      p = info.outputs[i];\n      if (!_outputMap.hasOwnProperty(p.id)) _outputMap[p.id] = new _OutputProxy(p.id, p.name, p.manufacturer, p.version);\n    }\n    if (!_wma.length) JZZ().onChange(_wm_watch);\n    _wma.push(this);\n  }\n\n  JZZ.requestMIDIAccess = function(opt) {\n    return new Promise(function(resolve, reject) {\n      JZZ.JZZ(opt).or(function() {\n      }).and(function() {\n        var sysex = !!(opt && opt.sysex);\n        if (sysex && !this.info().sysex) reject(new DOMException('SecurityError', 'Sysex is not allowed', 18));\n        else {\n          var wma = new MIDIAccess(sysex);\n          resolve(wma);\n        }\n      });\n    });\n  };\n  if (typeof navigator !== 'undefined' && !navigator.requestMIDIAccess) navigator.requestMIDIAccess = JZZ.requestMIDIAccess;\n  JZZ.close = function() { if (_engine._close) _engine._close(); };\n\n  return JZZ;\n});\n\n//export {JZZ}\n\n\n//# sourceURL=webpack://Synthesizer/./src/js/JZZ.js?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/global */
/******/ 	(() => {
/******/ 		__webpack_require__.g = (function() {
/******/ 			if (typeof globalThis === 'object') return globalThis;
/******/ 			try {
/******/ 				return this || new Function('return this')();
/******/ 			} catch (e) {
/******/ 				if (typeof window === 'object') return window;
/******/ 			}
/******/ 		})();
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	var __webpack_exports__ = __webpack_require__("./src/js/JZZ.js");
/******/ 	
/******/ })()
;